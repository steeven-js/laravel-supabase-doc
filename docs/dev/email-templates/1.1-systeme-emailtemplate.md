# Module 1.1 : SystÃ¨me EmailTemplate - ModÃ¨le et Structure de DonnÃ©es

## ğŸ“‹ Vue d'ensemble

Le systÃ¨me EmailTemplate constitue le cÅ“ur de la gestion des communications par email dans le Dashboard Madinia. Il offre un systÃ¨me flexible de templates avec variables dynamiques, catÃ©gorisation avancÃ©e et gestion des modÃ¨les par dÃ©faut pour chaque type d'email.

## ğŸ—ï¸ Architecture du ModÃ¨le EmailTemplate

### Structure de Base

Le modÃ¨le `EmailTemplate` est conÃ§u pour gÃ©rer de maniÃ¨re sophistiquÃ©e les templates d'emails avec un systÃ¨me de catÃ©gories hiÃ©rarchiques et de variables dynamiques.

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Casts\Attribute;

class EmailTemplate extends Model
{
    protected $fillable = [
        'name',
        'category', 
        'sub_category',
        'subject',
        'body',
        'is_default',
        'is_active',
        'variables',
        'description'
    ];

    protected $casts = [
        'variables' => 'array',
        'is_default' => 'boolean',
        'is_active' => 'boolean',
    ];
}
```

### Champs de la Table

| Champ | Type | Description | Contraintes |
|-------|------|-------------|-------------|
| `id` | ID | Identifiant unique | Primary Key, Auto-increment |
| `name` | String | Nom du modÃ¨le | Required, Max 255 |
| `category` | Enum | CatÃ©gorie principale | Required, 4 valeurs possibles |
| `sub_category` | Enum | Sous-catÃ©gorie spÃ©cialisÃ©e | Required, 15 valeurs possibles |
| `subject` | String | Sujet de l'email | Required, Max 255 |
| `body` | Text | Corps de l'email avec variables | Required |
| `is_default` | Boolean | ModÃ¨le par dÃ©faut pour sa catÃ©gorie | Default: false |
| `is_active` | Boolean | Statut actif/inactif | Default: true |
| `variables` | JSON | Variables disponibles dans le template | Nullable |
| `description` | Text | Description du modÃ¨le | Nullable |

## ğŸ—‚ï¸ SystÃ¨me de CatÃ©gories et Sous-catÃ©gories

### CatÃ©gories Principales (4 types)

Le systÃ¨me organise les templates selon **4 catÃ©gories principales** correspondant aux phases de communication :

```php
const CATEGORIES = [
    'envoi_initial' => 'Envoi initial de devis',
    'rappel' => 'Rappel de devis', 
    'relance' => 'Relance de devis',
    'confirmation' => 'Confirmation de devis acceptÃ©'
];
```

#### ğŸ“¤ **1. Envoi Initial**
- **Usage** : Premier envoi de devis au client
- **Objectif** : PrÃ©senter la proposition de maniÃ¨re professionnelle
- **TonalitÃ©** : Accueillante, professionnelle, personnalisable

#### ğŸ”” **2. Rappel**
- **Usage** : Rappeler un devis en attente de rÃ©ponse
- **Objectif** : Relancer en douceur sans Ãªtre insistant
- **TonalitÃ©** : Courtoise, avec possibilitÃ© d'urgence

#### ğŸš€ **3. Relance**
- **Usage** : Suivi actif pour obtenir une rÃ©ponse
- **Objectif** : Encourager la dÃ©cision, proposer des ajustements
- **TonalitÃ©** : Proactive, orientÃ©e solution

#### âœ… **4. Confirmation**
- **Usage** : Confirmer l'acceptation d'un devis
- **Objectif** : Rassurer et organiser les prochaines Ã©tapes
- **TonalitÃ©** : Enthousiaste, organisationnelle

### Sous-catÃ©gories SpÃ©cialisÃ©es (15 types)

Chaque catÃ©gorie se dÃ©cline en **sous-catÃ©gories spÃ©cialisÃ©es** pour s'adapter aux diffÃ©rents contextes et tonalitÃ©s :

```php
const SUB_CATEGORIES = [
    // ğŸ¯ ENVOI INITIAL (5 sous-catÃ©gories)
    'promotionnel' => 'Promotionnel',
    'concis_direct' => 'Concis et direct', 
    'standard_professionnel' => 'Standard professionnel',
    'detaille_etapes' => 'DÃ©taillÃ© avec Ã©tapes',
    'personnalise_chaleureux' => 'PersonnalisÃ© et chaleureux',

    // ğŸ”” RAPPEL (3 sous-catÃ©gories)
    'rappel_offre_speciale' => 'Rappel avec offre spÃ©ciale',
    'rappel_date_expiration' => 'Rappel avec date d\'expiration',
    'rappel_standard' => 'Rappel standard',

    // ğŸš€ RELANCE (3 sous-catÃ©gories)
    'suivi_standard' => 'Suivi standard',
    'suivi_ajustements' => 'Suivi avec ajustements possibles', 
    'suivi_feedback' => 'Suivi avec demande de feedback',

    // âœ… CONFIRMATION (4 sous-catÃ©gories)
    'confirmation_infos' => 'Confirmation avec demande d\'informations',
    'confirmation_etapes' => 'Confirmation avec Ã©tapes suivantes',
    'confirmation_standard' => 'Confirmation standard'
];
```

## ğŸ”§ SystÃ¨me de Variables et Remplacement

### Variables Dynamiques

Le systÃ¨me utilise un mÃ©canisme sophistiquÃ© de variables pour personnaliser automatiquement les emails :

```php
// Variables communes disponibles
$variables = [
    'client_nom' => 'Nom du client',
    'entreprise_nom' => 'Nom de l\'entreprise', 
    'devis_numero' => 'NumÃ©ro du devis',
    'devis_montant' => 'Montant du devis formatÃ©',
    'devis_validite' => 'Date de validitÃ©',
    'devis_date' => 'Date du devis',
    'contact_nom' => 'Nom du contact',
    'contact_email' => 'Email de contact',
    'contact_telephone' => 'TÃ©lÃ©phone de contact'
];
```

### Double Format de Variables

Le systÃ¨me supporte **deux formats de variables** pour une flexibilitÃ© maximale :

```php
public function processTemplate(array $data = [])
{
    $subject = $this->subject;
    $body = $this->body;

    foreach ($data as $key => $value) {
        // Format double accolades : {{variable}}
        $subject = str_replace("{{{$key}}}", $value, $subject); 
        $body = str_replace("{{{$key}}}", $value, $body);
        
        // Format simple accolades : {variable} 
        $subject = str_replace("{{$key}}", $value, $subject);
        $body = str_replace("{{$key}}", $value, $body);
    }

    return [
        'subject' => $subject,
        'body' => $body
    ];
}
```

### Exemples d'Utilisation

```php
// Template avec variables
$subject = "Devis {{devis_numero}} - {{entreprise_nom}}";
$body = "Bonjour {{client_nom}}, votre devis de {{devis_montant}} est prÃªt.";

// DonnÃ©es de remplacement
$data = [
    'devis_numero' => 'DV-25-001',
    'entreprise_nom' => 'TechCorp',
    'client_nom' => 'M. Dupont',
    'devis_montant' => '2 500,00 â‚¬'
];

// RÃ©sultat traitÃ©
$processed = $template->processTemplate($data);
// Subject: "Devis DV-25-001 - TechCorp"  
// Body: "Bonjour M. Dupont, votre devis de 2 500,00 â‚¬ est prÃªt."
```

## ğŸ¯ Gestion des Templates par DÃ©faut

### SystÃ¨me d'ExclusivitÃ©

Chaque catÃ©gorie peut avoir **un seul template par dÃ©faut** grÃ¢ce Ã  un systÃ¨me d'exclusivitÃ© automatique :

```php
public function setAsDefault()
{
    // Retirer le statut par dÃ©faut des autres modÃ¨les de la mÃªme catÃ©gorie
    self::where('category', $this->category)
        ->where('id', '!=', $this->id)
        ->update(['is_default' => false]);

    // DÃ©finir ce modÃ¨le comme par dÃ©faut
    $this->update(['is_default' => true]);
}
```

### RÃ©cupÃ©ration du Template par DÃ©faut

```php
public static function getDefaultForCategory($category)
{
    return self::active()
        ->defaultForCategory($category)
        ->first();
}
```

## ğŸ“Š Scopes et RequÃªtes OptimisÃ©es

### Scopes Eloquent

Le modÃ¨le propose plusieurs scopes pour des requÃªtes optimisÃ©es :

```php
// Scope pour les modÃ¨les actifs
public function scopeActive($query)
{
    return $query->where('is_active', true);
}

// Scope par catÃ©gorie
public function scopeByCategory($query, $category)
{
    return $query->where('category', $category);
}

// Scope pour le modÃ¨le par dÃ©faut d'une catÃ©gorie
public function scopeDefaultForCategory($query, $category)
{
    return $query->where('category', $category)
                 ->where('is_default', true);
}
```

### Exemples de RequÃªtes

```php
// RÃ©cupÃ©rer tous les templates actifs d'envoi initial
$templates = EmailTemplate::active()
    ->byCategory('envoi_initial')
    ->orderBy('name')
    ->get();

// RÃ©cupÃ©rer le template par dÃ©faut pour les rappels
$defaultTemplate = EmailTemplate::defaultForCategory('rappel');

// RequÃªte avec sous-catÃ©gories
$promotionnels = EmailTemplate::active()
    ->where('sub_category', 'promotionnel')
    ->get();
```

## ğŸ·ï¸ Accessors et Formatage

### Accessors pour Affichage

Le modÃ¨le propose des accessors pour un affichage formatÃ© :

```php
// Accessor pour le nom de la catÃ©gorie
protected function categoryName(): Attribute
{
    return Attribute::make(
        get: fn () => self::CATEGORIES[$this->category] ?? $this->category,
    );
}

// Accessor pour le nom de la sous-catÃ©gorie  
protected function subCategoryName(): Attribute
{
    return Attribute::make(
        get: fn () => self::SUB_CATEGORIES[$this->sub_category] ?? $this->sub_category,
    );
}
```

### Utilisation des Accessors

```php
$template = EmailTemplate::find(1);

echo $template->category;      // "envoi_initial"
echo $template->category_name; // "Envoi initial de devis"

echo $template->sub_category;      // "promotionnel"  
echo $template->sub_category_name; // "Promotionnel"
```

## ğŸ”„ MÃ©thodes Utilitaires

### RÃ©cupÃ©ration des Sous-catÃ©gories

```php
public static function getSubCategoriesForCategory($category)
{
    $mapping = [
        'envoi_initial' => [
            'promotionnel', 'concis_direct', 'standard_professionnel',
            'detaille_etapes', 'personnalise_chaleureux'
        ],
        'rappel' => [
            'rappel_offre_speciale', 'rappel_date_expiration', 'rappel_standard'
        ],
        'relance' => [
            'suivi_standard', 'suivi_ajustements', 'suivi_feedback'
        ],
        'confirmation' => [
            'confirmation_infos', 'confirmation_etapes', 'confirmation_standard'
        ]
    ];

    return $mapping[$category] ?? [];
}
```

## ğŸ“ˆ MÃ©triques et Statistiques

### DonnÃ©es du SystÃ¨me

- **4 catÃ©gories principales** : Envoi initial, Rappel, Relance, Confirmation
- **15 sous-catÃ©gories** : RÃ©partition Ã©quilibrÃ©e selon les besoins mÃ©tier
- **Variables illimitÃ©es** : SystÃ¨me flexible d'ajout de variables
- **Templates par dÃ©faut** : Un par catÃ©gorie pour usage automatique
- **Support dual** : Variables simple et double accolades

### Architecture Flexible

```mermaid
graph TD
    A[EmailTemplate] --> B[Categories 4]
    B --> C[Envoi Initial]
    B --> D[Rappel] 
    B --> E[Relance]
    B --> F[Confirmation]
    
    C --> C1[Promotionnel]
    C --> C2[Concis Direct]
    C --> C3[Standard Pro]
    C --> C4[DÃ©taillÃ© Ã‰tapes]
    C --> C5[PersonnalisÃ©]
    
    D --> D1[Offre SpÃ©ciale]
    D --> D2[Date Expiration]
    D --> D3[Standard]
    
    E --> E1[Standard]
    E --> E2[Ajustements]
    E --> E3[Feedback]
    
    F --> F1[Demande Infos]
    F --> F2[Ã‰tapes Suivantes]
    F --> F3[Standard]
```

## ğŸ¯ Points Forts du SystÃ¨me

### âœ… Avantages

1. **FlexibilitÃ©** : 15 sous-catÃ©gories pour tous les contextes
2. **Automatisation** : Variables dynamiques avec double format
3. **CohÃ©rence** : Templates par dÃ©faut pour chaque catÃ©gorie
4. **Performance** : Scopes optimisÃ©s et index sur les colonnes critiques
5. **Ã‰volutivitÃ©** : Facile d'ajouter de nouvelles catÃ©gories/variables
6. **UX** : Accessors pour affichage formatÃ© dans l'interface

### ğŸ”§ Optimisations Techniques

1. **Index DB** : Sur `(category, is_default)` et `(category, sub_category)`
2. **Casts Laravel** : JSON pour variables, Boolean pour flags
3. **Validation** : Rules strictes avec enums pour categories
4. **Scopes** : RequÃªtes mÃ©tier optimisÃ©es
5. **Accessors** : Affichage formatÃ© sans logique dans les vues

## ğŸ“ Conclusion

Le systÃ¨me EmailTemplate offre une base solide et flexible pour la gestion des communications email. Avec ses 4 catÃ©gories principales et 15 sous-catÃ©gories, il couvre tous les besoins de communication liÃ©s aux devis tout en restant facilement extensible pour d'autres modules (factures, clients, etc.).

L'architecture modulaire et les mÃ©thodes mÃ©tier permettent une utilisation simple tout en conservant la puissance nÃ©cessaire pour des cas d'usage complexes. 
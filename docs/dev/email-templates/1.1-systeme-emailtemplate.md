# Module 1.1 : Syst√®me EmailTemplate - Mod√®le et Structure de Donn√©es

## üìã Vue d'ensemble

Le syst√®me EmailTemplate constitue le c≈ìur de la gestion des communications par email dans le Dashboard Madinia. Il offre un syst√®me flexible de templates avec variables dynamiques, cat√©gorisation avanc√©e et gestion des mod√®les par d√©faut pour chaque type d'email.

## üèóÔ∏è Architecture du Mod√®le EmailTemplate

### Structure de Base

Le mod√®le `EmailTemplate` est con√ßu pour g√©rer de mani√®re sophistiqu√©e les templates d'emails avec un syst√®me de cat√©gories hi√©rarchiques et de variables dynamiques.

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Casts\Attribute;

class EmailTemplate extends Model
{
    protected $fillable = [
        'name',
        'category', 
        'sub_category',
        'subject',
        'body',
        'is_default',
        'is_active',
        'variables',
        'description'
    ];

    protected $casts = [
        'variables' => 'array',
        'is_default' => 'boolean',
        'is_active' => 'boolean',
    ];
}
```

### Champs de la Table

| Champ | Type | Description | Contraintes |
|-------|------|-------------|-------------|
| `id` | ID | Identifiant unique | Primary Key, Auto-increment |
| `name` | String | Nom du mod√®le | Required, Max 255 |
| `category` | Enum | Cat√©gorie principale | Required, 4 valeurs possibles |
| `sub_category` | Enum | Sous-cat√©gorie sp√©cialis√©e | Required, 15 valeurs possibles |
| `subject` | String | Sujet de l'email | Required, Max 255 |
| `body` | Text | Corps de l'email avec variables | Required |
| `is_default` | Boolean | Mod√®le par d√©faut pour sa cat√©gorie | Default: false |
| `is_active` | Boolean | Statut actif/inactif | Default: true |
| `variables` | JSON | Variables disponibles dans le template | Nullable |
| `description` | Text | Description du mod√®le | Nullable |

## üóÇÔ∏è Syst√®me de Cat√©gories et Sous-cat√©gories

### Cat√©gories Principales (4 types)

Le syst√®me organise les templates selon **4 cat√©gories principales** correspondant aux phases de communication :

```php
const CATEGORIES = [
    'envoi_initial' => 'Envoi initial de devis',
    'rappel' => 'Rappel de devis', 
    'relance' => 'Relance de devis',
    'confirmation' => 'Confirmation de devis accept√©'
];
```

#### üì§ **1. Envoi Initial**
- **Usage** : Premier envoi de devis au client
- **Objectif** : Pr√©senter la proposition de mani√®re professionnelle
- **Tonalit√©** : Accueillante, professionnelle, personnalisable

#### üîî **2. Rappel**
- **Usage** : Rappeler un devis en attente de r√©ponse
- **Objectif** : Relancer en douceur sans √™tre insistant
- **Tonalit√©** : Courtoise, avec possibilit√© d'urgence

#### üöÄ **3. Relance**
- **Usage** : Suivi actif pour obtenir une r√©ponse
- **Objectif** : Encourager la d√©cision, proposer des ajustements
- **Tonalit√©** : Proactive, orient√©e solution

#### ‚úÖ **4. Confirmation**
- **Usage** : Confirmer l'acceptation d'un devis
- **Objectif** : Rassurer et organiser les prochaines √©tapes
- **Tonalit√©** : Enthousiaste, organisationnelle

### Sous-cat√©gories Sp√©cialis√©es (15 types)

Chaque cat√©gorie se d√©cline en **sous-cat√©gories sp√©cialis√©es** pour s'adapter aux diff√©rents contextes et tonalit√©s :

```php
const SUB_CATEGORIES = [
    // üéØ ENVOI INITIAL (5 sous-cat√©gories)
    'promotionnel' => 'Promotionnel',
    'concis_direct' => 'Concis et direct', 
    'standard_professionnel' => 'Standard professionnel',
    'detaille_etapes' => 'D√©taill√© avec √©tapes',
    'personnalise_chaleureux' => 'Personnalis√© et chaleureux',

    // üîî RAPPEL (3 sous-cat√©gories)
    'rappel_offre_speciale' => 'Rappel avec offre sp√©ciale',
    'rappel_date_expiration' => 'Rappel avec date d\'expiration',
    'rappel_standard' => 'Rappel standard',

    // üöÄ RELANCE (3 sous-cat√©gories)
    'suivi_standard' => 'Suivi standard',
    'suivi_ajustements' => 'Suivi avec ajustements possibles', 
    'suivi_feedback' => 'Suivi avec demande de feedback',

    // ‚úÖ CONFIRMATION (4 sous-cat√©gories)
    'confirmation_infos' => 'Confirmation avec demande d\'informations',
    'confirmation_etapes' => 'Confirmation avec √©tapes suivantes',
    'confirmation_standard' => 'Confirmation standard'
];
```

## üîß Syst√®me de Variables et Remplacement

### Variables Dynamiques

Le syst√®me utilise un m√©canisme sophistiqu√© de variables pour personnaliser automatiquement les emails :

```php
// Variables communes disponibles
$variables = [
    'client_nom' => 'Nom du client',
    'entreprise_nom' => 'Nom de l\'entreprise', 
    'devis_numero' => 'Num√©ro du devis',
    'devis_montant' => 'Montant du devis format√©',
    'devis_validite' => 'Date de validit√©',
    'devis_date' => 'Date du devis',
    'contact_nom' => 'Nom du contact',
    'contact_email' => 'Email de contact',
    'contact_telephone' => 'T√©l√©phone de contact'
];
```

### Double Format de Variables

Le syst√®me supporte **deux formats de variables** pour une flexibilit√© maximale :

```php
public function processTemplate(array $data = [])
{
    $subject = $this->subject;
    $body = $this->body;

    foreach ($data as $key => $value) {
        // Format double accolades : {{variable}}
        $subject = str_replace("{{{$key}}}", $value, $subject); 
        $body = str_replace("{{{$key}}}", $value, $body);
        
        // Format simple accolades : {variable} 
        $subject = str_replace("{{$key}}", $value, $subject);
        $body = str_replace("{{$key}}", $value, $body);
    }

    return [
        'subject' => $subject,
        'body' => $body
    ];
}
```

### Exemples d'Utilisation

```php
// Template avec variables
$subject = "Devis {{devis_numero}} - {{entreprise_nom}}";
$body = "Bonjour {{client_nom}}, votre devis de {{devis_montant}} est pr√™t.";

// Donn√©es de remplacement
$data = [
    'devis_numero' => 'DV-25-001',
    'entreprise_nom' => 'TechCorp',
    'client_nom' => 'M. Dupont',
    'devis_montant' => '2 500,00 ‚Ç¨'
];

// R√©sultat trait√©
$processed = $template->processTemplate($data);
// Subject: "Devis DV-25-001 - TechCorp"  
// Body: "Bonjour M. Dupont, votre devis de 2 500,00 ‚Ç¨ est pr√™t."
```

## üéØ Gestion des Templates par D√©faut

### Syst√®me d'Exclusivit√©

Chaque cat√©gorie peut avoir **un seul template par d√©faut** gr√¢ce √† un syst√®me d'exclusivit√© automatique :

```php
public function setAsDefault()
{
    // Retirer le statut par d√©faut des autres mod√®les de la m√™me cat√©gorie
    self::where('category', $this->category)
        ->where('id', '!=', $this->id)
        ->update(['is_default' => false]);

    // D√©finir ce mod√®le comme par d√©faut
    $this->update(['is_default' => true]);
}
```

### R√©cup√©ration du Template par D√©faut

```php
public static function getDefaultForCategory($category)
{
    return self::active()
        ->defaultForCategory($category)
        ->first();
}
```

## üìä Scopes et Requ√™tes Optimis√©es

### Scopes Eloquent

Le mod√®le propose plusieurs scopes pour des requ√™tes optimis√©es :

```php
// Scope pour les mod√®les actifs
public function scopeActive($query)
{
    return $query->where('is_active', true);
}

// Scope par cat√©gorie
public function scopeByCategory($query, $category)
{
    return $query->where('category', $category);
}

// Scope pour le mod√®le par d√©faut d'une cat√©gorie
public function scopeDefaultForCategory($query, $category)
{
    return $query->where('category', $category)
                 ->where('is_default', true);
}
```

### Exemples de Requ√™tes

```php
// R√©cup√©rer tous les templates actifs d'envoi initial
$templates = EmailTemplate::active()
    ->byCategory('envoi_initial')
    ->orderBy('name')
    ->get();

// R√©cup√©rer le template par d√©faut pour les rappels
$defaultTemplate = EmailTemplate::defaultForCategory('rappel');

// Requ√™te avec sous-cat√©gories
$promotionnels = EmailTemplate::active()
    ->where('sub_category', 'promotionnel')
    ->get();
```

## üè∑Ô∏è Accessors et Formatage

### Accessors pour Affichage

Le mod√®le propose des accessors pour un affichage format√© :

```php
// Accessor pour le nom de la cat√©gorie
protected function categoryName(): Attribute
{
    return Attribute::make(
        get: fn () => self::CATEGORIES[$this->category] ?? $this->category,
    );
}

// Accessor pour le nom de la sous-cat√©gorie  
protected function subCategoryName(): Attribute
{
    return Attribute::make(
        get: fn () => self::SUB_CATEGORIES[$this->sub_category] ?? $this->sub_category,
    );
}
```

### Utilisation des Accessors

```php
$template = EmailTemplate::find(1);

echo $template->category;      // "envoi_initial"
echo $template->category_name; // "Envoi initial de devis"

echo $template->sub_category;      // "promotionnel"  
echo $template->sub_category_name; // "Promotionnel"
```

## üîÑ M√©thodes Utilitaires

### R√©cup√©ration des Sous-cat√©gories

```php
public static function getSubCategoriesForCategory($category)
{
    $mapping = [
        'envoi_initial' => [
            'promotionnel', 'concis_direct', 'standard_professionnel',
            'detaille_etapes', 'personnalise_chaleureux'
        ],
        'rappel' => [
            'rappel_offre_speciale', 'rappel_date_expiration', 'rappel_standard'
        ],
        'relance' => [
            'suivi_standard', 'suivi_ajustements', 'suivi_feedback'
        ],
        'confirmation' => [
            'confirmation_infos', 'confirmation_etapes', 'confirmation_standard'
        ]
    ];

    return $mapping[$category] ?? [];
}
```

## üìà M√©triques et Statistiques

### Donn√©es du Syst√®me

- **4 cat√©gories principales** : Envoi initial, Rappel, Relance, Confirmation
- **15 sous-cat√©gories** : R√©partition √©quilibr√©e selon les besoins m√©tier
- **Variables illimit√©es** : Syst√®me flexible d'ajout de variables
- **Templates par d√©faut** : Un par cat√©gorie pour usage automatique
- **Support dual** : Variables simple et double accolades

### Architecture Flexible

```mermaid
graph TD
    A[EmailTemplate] --> B[Categories 4]
    B --> C[Envoi Initial]
    B --> D[Rappel] 
    B --> E[Relance]
    B --> F[Confirmation]
    
    C --> C1[Promotionnel]
    C --> C2[Concis Direct]
    C --> C3[Standard Pro]
    C --> C4[D√©taill√© √âtapes]
    C --> C5[Personnalis√©]
    
    D --> D1[Offre Sp√©ciale]
    D --> D2[Date Expiration]
    D --> D3[Standard]
    
    E --> E1[Standard]
    E --> E2[Ajustements]
    E --> E3[Feedback]
    
    F --> F1[Demande Infos]
    F --> F2[√âtapes Suivantes]
    F --> F3[Standard]
```

## üéØ Points Forts du Syst√®me

### ‚úÖ Avantages

1. **Flexibilit√©** : 15 sous-cat√©gories pour tous les contextes
2. **Automatisation** : Variables dynamiques avec double format
3. **Coh√©rence** : Templates par d√©faut pour chaque cat√©gorie
4. **Performance** : Scopes optimis√©s et index sur les colonnes critiques
5. **√âvolutivit√©** : Facile d'ajouter de nouvelles cat√©gories/variables
6. **UX** : Accessors pour affichage format√© dans l'interface

### üîß Optimisations Techniques

1. **Index DB** : Sur `(category, is_default)` et `(category, sub_category)`
2. **Casts Laravel** : JSON pour variables, Boolean pour flags
3. **Validation** : Rules strictes avec enums pour categories
4. **Scopes** : Requ√™tes m√©tier optimis√©es
5. **Accessors** : Affichage format√© sans logique dans les vues

## üìù Conclusion

Le syst√®me EmailTemplate offre une base solide et flexible pour la gestion des communications email. Avec ses 4 cat√©gories principales et 15 sous-cat√©gories, il couvre tous les besoins de communication li√©s aux devis tout en restant facilement extensible pour d'autres modules (factures, clients, etc.).

L'architecture modulaire et les m√©thodes m√©tier permettent une utilisation simple tout en conservant la puissance n√©cessaire pour des cas d'usage complexes. 
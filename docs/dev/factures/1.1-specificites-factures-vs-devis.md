# Module 1.1 : SpÃ©cificitÃ©s Factures vs Devis

## ğŸ“‹ Vue d'ensemble

Ce module documente les diffÃ©rences architecturales majeures entre le systÃ¨me de factures et celui des devis dans le Dashboard Madinia. Il couvre les spÃ©cificitÃ©s mÃ©tier, le workflow fiscal, les contraintes lÃ©gales et le cycle de vie complet d'une facture.

## ğŸ—ï¸ DiffÃ©rences Architecturales Majeures

### Comparaison Structurelle

```mermaid
graph TB
    subgraph "ğŸ¯ DEVIS - Phase Commerciale"
        D1[Prospection Client]
        D2[Proposition Commerciale]
        D3[NÃ©gociation]
        D4[Acceptation/Refus]
        D5[Transformation Facture]
    end
    
    subgraph "ğŸ§¾ FACTURES - Phase Fiscale"
        F1[Document Fiscal Officiel]
        F2[Obligations LÃ©gales]
        F3[Suivi Paiements]
        F4[Gestion Ã‰chÃ©ances]
        F5[ComptabilitÃ©]
    end
    
    D4 --> F1
    D5 --> F1
    
    style D1 fill:#e3f2fd
    style F1 fill:#e8f5e8
```

### Tableau Comparatif DÃ©taillÃ©

| Aspect | **Devis** | **Factures** |
|--------|-----------|--------------|
| **ğŸ¯ Objectif** | Proposition commerciale | Document fiscal officiel |
| **ğŸ“„ Nature** | Engagement conditionnel | Obligation de paiement |
| **âš–ï¸ Statut lÃ©gal** | Non contraignant | Contraignant lÃ©galement |
| **ğŸ”„ Ã‰volution** | Peut Ãªtre modifiÃ©/refusÃ© | GÃ©nÃ©ralement immuable |
| **ğŸ’° FinalitÃ©** | Obtenir une commande | Encaisser un paiement |
| **ğŸ“… ValiditÃ©** | LimitÃ©e dans le temps | Permanente |
| **ğŸ›ï¸ Archivage** | Facultatif | Obligatoire (10 ans) |

## ğŸ”„ Workflow Fiscal et Contraintes LÃ©gales

### Cycle de Vie Fiscal d'une Facture

```mermaid
stateDiagram-v2
    [*] --> Brouillon : CrÃ©ation
    
    Brouillon --> En_Attente : Finalisation
    En_Attente --> Envoyee : Transmission Client
    
    Envoyee --> Payee : Paiement ReÃ§u
    Envoyee --> En_Retard : Ã‰chÃ©ance DÃ©passÃ©e
    En_Retard --> Payee : Paiement Tardif
    
    Brouillon --> Annulee : Annulation
    En_Attente --> Annulee : Annulation
    
    Payee --> [*] : Archivage
    Annulee --> [*] : Archivage
    
    note right of Payee
        Obligation comptable
        DÃ©claration TVA
        Conservation 10 ans
    end note
    
    note right of En_Retard
        Relances automatiques
        PÃ©nalitÃ©s possibles
        Suivi juridique
    end note
```

### Contraintes LÃ©gales SpÃ©cifiques

```php
// Obligations fiscales dans le modÃ¨le Facture
class Facture extends Model
{
    // Champs obligatoires selon la rÃ©glementation franÃ§aise
    protected $fillable = [
        'numero_facture',        // NumÃ©rotation sÃ©quentielle obligatoire
        'date_facture',          // Date d'Ã©mission obligatoire
        'date_echeance',         // Date limite de paiement
        'client_id',             // Identification client obligatoire
        'montant_ht',            // Montant HT obligatoire
        'taux_tva',              // Taux TVA obligatoire
        'montant_tva',           // Montant TVA calculÃ©
        'montant_ttc',           // Montant TTC final
        // Champs de paiement spÃ©cifiques aux factures
        'date_paiement',         // Date effective du paiement
        'mode_paiement',         // Moyen de paiement utilisÃ©
        'reference_paiement',    // RÃ©fÃ©rence/numÃ©ro de transaction
    ];
    
    // RÃ¨gles de validation fiscale
    public function validateFiscal(): bool
    {
        return $this->numero_facture &&
               $this->date_facture &&
               $this->client_id &&
               $this->montant_ttc > 0 &&
               $this->taux_tva >= 0;
    }
}
```

## ğŸ”— IntÃ©grations avec le SystÃ¨me de Devis

### Architecture d'IntÃ©gration

```mermaid
graph LR
    subgraph "ğŸ¯ SystÃ¨me Devis"
        D[Devis AcceptÃ©]
        DC[DevisController]
        DM[ModÃ¨le Devis]
        DL[LigneDevis]
    end
    
    subgraph "ğŸ”„ Zone de Transformation"
        T[MÃ©thode creerDepuisDevis()]
        V[Validation DonnÃ©es]
        C[Copie Lignes]
        M[Calcul Montants]
    end
    
    subgraph "ğŸ§¾ SystÃ¨me Factures"
        F[Nouvelle Facture]
        FC[FactureController]
        FM[ModÃ¨le Facture]
        FL[LigneFacture]
    end
    
    D --> T
    DC --> T
    DM --> V
    DL --> C
    
    T --> F
    V --> FM
    C --> FL
    M --> FM
    
    style T fill:#fff3cd
    style V fill:#d1ecf1
    style C fill:#d4edda
    style M fill:#f8d7da
```

### MÃ©thode de Transformation DÃ©taillÃ©e

```php
// Dans le modÃ¨le Facture.php
public static function creerDepuisDevis(Devis $devis): self
{
    // 1. Validation prÃ©alable
    if (!$devis->peutEtreTransformeEnFacture()) {
        throw new \Exception("Ce devis ne peut pas Ãªtre transformÃ© en facture");
    }
    
    // 2. Chargement des relations nÃ©cessaires
    $devis->load(['administrateur', 'lignes.service', 'client']);
    
    // 3. CrÃ©ation de la facture de base
    $facture = new self([
        'numero_facture' => self::genererNumeroFacture(),
        'devis_id' => $devis->id,              // Lien vers devis d'origine
        'client_id' => $devis->client_id,
        'administrateur_id' => $devis->administrateur?->id,
        'date_facture' => now()->toDateString(),
        'date_echeance' => now()->addDays(30)->toDateString(),
        'statut' => 'brouillon',
        'objet' => $devis->objet,
        'description' => $devis->description,
        'conditions_paiement' => $devis->conditions ?? 'Paiement Ã  30 jours',
        'notes' => $devis->notes,
    ]);
    
    $facture->save();
    
    // 4. Copie des lignes de services
    foreach ($devis->lignes as $ligneDevis) {
        $facture->lignes()->create([
            'service_id' => $ligneDevis->service_id,
            'quantite' => $ligneDevis->quantite,
            'prix_unitaire_ht' => $ligneDevis->prix_unitaire_ht,
            'taux_tva' => $ligneDevis->taux_tva,
            'ordre' => $ligneDevis->ordre,
            'description_personnalisee' => $ligneDevis->description_personnalisee,
            // Les montants seront calculÃ©s automatiquement via boot()
        ]);
    }
    
    // 5. Recalcul des montants totaux
    $facture->calculerMontants();
    $facture->save();
    
    // 6. TraÃ§abilitÃ© dans l'historique
    $devis->enregistrerHistorique(
        'transformation',
        "Transformation en facture",
        "Le devis #{$devis->numero_devis} a Ã©tÃ© transformÃ© en facture #{$facture->numero_facture}",
        null,
        null,
        [
            'facture_id' => $facture->id,
            'numero_facture' => $facture->numero_facture,
            'date_transformation' => now()->format('Y-m-d H:i:s')
        ]
    );
    
    return $facture;
}
```

## ğŸ”„ Cycle de Vie Complet d'une Facture

### Phase 1 : CrÃ©ation et PrÃ©paration

```php
// 1. CrÃ©ation manuelle
$facture = new Facture([
    'numero_facture' => Facture::genererNumeroFacture(),
    'client_id' => $client->id,
    'date_facture' => now()->toDateString(),
    'date_echeance' => now()->addDays(30)->toDateString(),
    'statut' => 'brouillon',
]);

// 2. Ou transformation depuis devis
$facture = Facture::creerDepuisDevis($devis);

// 3. Ajout de lignes de services
$facture->lignes()->create([
    'service_id' => $service->id,
    'quantite' => 10,
    'prix_unitaire_ht' => 120.00,
            'taux_tva' => 8.5,
]);

// 4. Calcul automatique des montants
$facture->calculerMontants(); // Montants HT/TTC/TVA
```

### Phase 2 : Validation et Envoi

```php
// 1. Passage en attente (validation interne)
$facture->statut = 'en_attente';
$facture->save();

// 2. GÃ©nÃ©ration du PDF officiel
$pdfService = new FacturePdfService();
$pdfContent = $pdfService->genererPdf($facture, $madinia);
$pdfService->sauvegarderLocal($facture, $pdfContent);

// 3. Envoi au client
$facture->marquerEnvoyee(); // Statut -> 'envoyee'

// 4. Envoi email avec PDF en piÃ¨ce jointe
Mail::to($facture->client->email)->send(
    new FactureClientMail($facture, $pdfPath)
);
```

### Phase 3 : Suivi et Paiement

```php
// 1. VÃ©rification automatique des retards
$facturesEnRetard = Facture::enRetard()->get();
foreach ($facturesEnRetard as $facture) {
    $facture->statut = 'en_retard';
    $facture->save();
    
    // Envoi relance automatique
    Mail::to($facture->client->email)->send(
        new RelanceFactureMail($facture)
    );
}

// 2. Marquage du paiement
$facture->marquerPayee(
    'Virement bancaire',           // Mode de paiement
    'VIR-2025-001234'             // RÃ©fÃ©rence de paiement
);

// 3. IntÃ©gration comptable
$this->integrerComptabilite($facture);
```

### Phase 4 : Archivage et ConformitÃ©

```php
// 1. Archivage lÃ©gal (obligatoire 10 ans)
$facture->archive = true;
$facture->save();

// 2. Sauvegarde sÃ©curisÃ©e
$this->sauvegarderArchiveLegale($facture);

// 3. DÃ©claration TVA
$this->inclureDansDeclarationTva($facture);

// 4. Export comptable
$this->exporterVersSageCompta($facture);
```

## ğŸ¯ SpÃ©cificitÃ©s MÃ©tier des Factures

### Gestion des Paiements

```php
class Facture extends Model
{
    /**
     * Marquer comme payÃ©e avec traÃ§abilitÃ© complÃ¨te
     */
    public function marquerPayee(?string $modePaiement = null, ?string $reference = null): bool
    {
        $ancienStatut = $this->statut;
        
        // Mise Ã  jour des champs de paiement
        $this->statut = 'payee';
        $this->date_paiement = now()->toDateString();
        $this->mode_paiement = $modePaiement;
        $this->reference_paiement = $reference;
        
        $result = $this->save();
        
        if ($result) {
            // Historique dÃ©taillÃ© du paiement
            $this->enregistrerHistorique(
                'changement_statut',
                "Facture marquÃ©e comme payÃ©e",
                "La facture #{$this->numero_facture} a Ã©tÃ© marquÃ©e comme payÃ©e",
                [
                    'statut' => $ancienStatut,
                    'date_paiement' => null,
                    'mode_paiement' => null,
                    'reference_paiement' => null
                ],
                [
                    'statut' => 'payee',
                    'date_paiement' => $this->date_paiement,
                    'mode_paiement' => $modePaiement,
                    'reference_paiement' => $reference
                ],
                [
                    'montant_paye' => $this->montant_ttc
                ]
            );
            
            // Notification automatique des parties prenantes
            $this->envoyerNotificationPaiement();
        }
        
        return $result;
    }
    
    /**
     * VÃ©rification automatique des retards
     */
    public function getEstEnRetardAttribute(): bool
    {
        return $this->date_echeance < now() &&
               in_array($this->statut, ['envoyee', 'en_attente', 'brouillon']);
    }
}
```

### Gestion des Ã‰chÃ©ances

```php
// Commande artisan pour traitement automatique des Ã©chÃ©ances
class ProcessFactureEcheancesCommand extends Command
{
    protected $signature = 'factures:process-echeances';
    
    public function handle()
    {
        // 1. Factures arrivant Ã  Ã©chÃ©ance (3 jours avant)
        $facturesPreEcheance = Facture::where('date_echeance', '=', now()->addDays(3)->toDateString())
                                     ->where('statut', 'envoyee')
                                     ->get();
        
        foreach ($facturesPreEcheance as $facture) {
            Mail::to($facture->client->email)->send(new RappelEcheanceMail($facture));
        }
        
        // 2. Factures en retard (Ã©chÃ©ance dÃ©passÃ©e)
        $facturesEnRetard = Facture::where('date_echeance', '<', now()->toDateString())
                                  ->whereIn('statut', ['envoyee', 'en_attente'])
                                  ->get();
        
        foreach ($facturesEnRetard as $facture) {
            $facture->statut = 'en_retard';
            $facture->save();
            
            Mail::to($facture->client->email)->send(new RelanceRetardMail($facture));
        }
        
        $this->info("Traitement terminÃ© : {$facturesPreEcheance->count()} rappels, {$facturesEnRetard->count()} retards");
    }
}
```

## ğŸ“Š Indicateurs et Statistiques SpÃ©cialisÃ©s

### MÃ©triques FinanciÃ¨res

```php
// Service de calcul des mÃ©triques factures
class FactureMetricsService
{
    public function getIndicateursFinanciers(int $annee = null): array
    {
        $annee = $annee ?? date('Y');
        
        return [
            // Chiffre d'affaires rÃ©alisÃ©
            'ca_realise' => Facture::where('statut', 'payee')
                                  ->whereYear('date_paiement', $annee)
                                  ->sum('montant_ttc'),
            
            // CA en attente de paiement
            'ca_en_attente' => Facture::whereIn('statut', ['envoyee', 'en_attente'])
                                     ->whereYear('date_facture', $annee)
                                     ->sum('montant_ttc'),
            
            // Factures en retard
            'montant_retards' => Facture::where('statut', 'en_retard')
                                       ->whereYear('date_facture', $annee)
                                       ->sum('montant_ttc'),
            
            // DÃ©lai moyen de paiement
            'delai_moyen_paiement' => $this->calculerDelaiMoyenPaiement($annee),
            
            // Taux de retard
            'taux_retard' => $this->calculerTauxRetard($annee),
        ];
    }
    
    private function calculerDelaiMoyenPaiement(int $annee): float
    {
        return Facture::where('statut', 'payee')
                     ->whereYear('date_paiement', $annee)
                     ->selectRaw('AVG(DATEDIFF(date_paiement, date_facture)) as delai_moyen')
                     ->value('delai_moyen') ?? 0;
    }
}
```

## ğŸ“‹ RÃ©sumÃ© des SpÃ©cificitÃ©s

### Points ClÃ©s de DiffÃ©renciation

1. **ğŸ›ï¸ Nature Juridique**
   - Devis : Proposition commerciale non contraignante
   - Facture : Document fiscal officiel et contraignant

2. **ğŸ’° Gestion FinanciÃ¨re**
   - Devis : Estimation de prix
   - Facture : CrÃ©ance Ã  encaisser avec suivi de paiement

3. **â° TemporalitÃ©**
   - Devis : ValiditÃ© limitÃ©e, modifiable
   - Facture : Permanente, immuable aprÃ¨s envoi

4. **ğŸ“Š Reporting**
   - Devis : Taux de conversion, pipeline commercial
   - Facture : Chiffre d'affaires, retards, trÃ©sorerie

5. **ğŸ”„ Workflow**
   - Devis : Prospection â†’ NÃ©gociation â†’ Acceptation
   - Facture : Ã‰mission â†’ Envoi â†’ Suivi â†’ Paiement

6. **âš–ï¸ ConformitÃ©**
   - Devis : Aucune obligation lÃ©gale
   - Facture : Nombreuses obligations fiscales et comptables

Cette architecture spÃ©cialisÃ©e garantit une sÃ©paration claire des responsabilitÃ©s tout en maintenant une intÃ©gration fluide entre les deux systÃ¨mes pour un processus commercial complet. 
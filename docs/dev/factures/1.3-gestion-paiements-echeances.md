# Module 1.3 : Gestion Paiements et √âch√©ances

## üìã Vue d'ensemble

Ce module documente le syst√®me complet de gestion des paiements et √©ch√©ances dans le Dashboard Madinia. Il couvre les 6 statuts m√©tier, les transitions automatiques, le calcul des retards, les m√©thodes de marquage de paiement et le suivi des r√©f√©rences de paiement.

## üìä Syst√®me de Statuts M√©tier

### Les 6 Statuts Principaux vs Devis (4 statuts)

```mermaid
stateDiagram-v2
    [*] --> Brouillon : Cr√©ation
    
    Brouillon --> En_Attente : Finalisation
    Brouillon --> Annulee : Annulation
    
    En_Attente --> Envoyee : Envoi Client
    En_Attente --> Annulee : Annulation
    
    Envoyee --> Payee : Paiement Re√ßu
    Envoyee --> En_Retard : √âch√©ance D√©pass√©e
    
    En_Retard --> Payee : Paiement Tardif
    
    Payee --> [*] : Archivage
    Annulee --> [*] : Archivage
    
    note right of En_Retard
        NOUVEAU STATUT
        Sp√©cifique aux factures
        Calcul automatique
    end note
    
    note left of Payee
        ENRICHI vs Devis
        + Date paiement
        + Mode paiement
        + R√©f√©rence
    end note
```

### D√©finition des Statuts

```php
// Enum des statuts facture dans la migration
$table->enum('statut', [
    'brouillon',    // Facture en cours de pr√©paration
    'en_attente',   // Finalis√©e, pr√™te √† l'envoi
    'envoyee',      // Envoy√©e au client
    'payee',        // Paiement re√ßu et confirm√©
    'en_retard',    // √âch√©ance d√©pass√©e (NOUVEAU vs devis)
    'annulee'       // Annul√©e
])->default('brouillon');

// Statut d'envoi s√©par√©
$table->enum('statut_envoi', [
    'non_envoyee',  // Pas encore envoy√©e
    'envoyee',      // Envoy√©e avec succ√®s
    'echec_envoi'   // √âchec lors de l'envoi
])->default('non_envoyee');
```

### Matrice de Transitions Autoris√©es

| **Depuis** | **Vers** | **Conditions** | **Actions Automatiques** |
|------------|----------|----------------|---------------------------|
| `brouillon` | `en_attente` | Validation compl√®te | Calcul montants |
| `brouillon` | `annulee` | D√©cision admin | Historique |
| `en_attente` | `envoyee` | Envoi r√©ussi | Date envoi + PDF |
| `en_attente` | `annulee` | D√©cision admin | Historique |
| `envoyee` | `payee` | Paiement confirm√© | Date + mode + r√©f√©rence |
| `envoyee` | `en_retard` | √âch√©ance d√©pass√©e | Calcul automatique |
| `en_retard` | `payee` | Paiement tardif | P√©nalit√©s √©ventuelles |

## ‚è∞ Calcul Automatique des Retards

### Logique de D√©tection

```php
/**
 * D√©terminer automatiquement si une facture est en retard
 * Appel√© par un accesseur et une commande cron
 */
public function getEstEnRetardAttribute(): bool
{
    // Conditions pour √™tre consid√©r√©e en retard :
    // 1. √âch√©ance d√©pass√©e (date_echeance < aujourd'hui)
    // 2. Statut permettant le retard (envoyee, en_attente, brouillon)
    // 3. Pas encore pay√©e (statut != 'payee')
    
    return $this->date_echeance < now()->toDate() &&
           in_array($this->statut, ['envoyee', 'en_attente', 'brouillon']) &&
           $this->statut !== 'payee';
}

/**
 * Calculer le nombre de jours de retard
 */
public function getJoursRetardAttribute(): int
{
    if (!$this->est_en_retard) {
        return 0;
    }
    
    return $this->date_echeance->diffInDays(now(), false);
}

/**
 * Calculer les p√©nalit√©s de retard (optionnel)
 */
public function getPenalitesRetardAttribute(): float
{
    if (!$this->est_en_retard || $this->jours_retard < 30) {
        return 0;
    }
    
    // Exemple : 1% du montant TTC par mois de retard
    $moisRetard = ceil($this->jours_retard / 30);
    return round($this->montant_ttc * 0.01 * $moisRetard, 2);
}
```

### Commande de Traitement Automatique

```php
// Console/Commands/ProcessFactureRetards.php
class ProcessFactureRetards extends Command
{
    protected $signature = 'factures:process-retards
                            {--dry-run : Afficher les changements sans les appliquer}
                            {--notify : Envoyer les notifications de relance}';
    
    protected $description = 'Traiter automatiquement les factures en retard';

    public function handle()
    {
        $dryRun = $this->option('dry-run');
        $notify = $this->option('notify');
        
        // =======================================
        // √âTAPE 1 : FACTURES ARRIVANT √Ä √âCH√âANCE
        // =======================================
        
        $facturesPreEcheance = Facture::where('date_echeance', '=', now()->addDays(3)->toDateString())
                                     ->where('statut', 'envoyee')
                                     ->with('client')
                                     ->get();
        
        $this->info("üìÖ Factures arrivant √† √©ch√©ance (J-3) : {$facturesPreEcheance->count()}");
        
        foreach ($facturesPreEcheance as $facture) {
            if ($notify && !$dryRun) {
                Mail::to($facture->client->email)->send(new RappelEcheanceMail($facture));
                $this->line("  üìß Rappel envoy√© pour facture #{$facture->numero_facture}");
            } else {
                $this->line("  üìß [DRY-RUN] Rappel pour facture #{$facture->numero_facture}");
            }
        }
        
        // =======================================
        // √âTAPE 2 : FACTURES EN RETARD
        // =======================================
        
        $facturesEnRetard = Facture::where('date_echeance', '<', now()->toDateString())
                                  ->whereIn('statut', ['envoyee', 'en_attente'])
                                  ->with('client')
                                  ->get();
        
        $this->info("üö® Factures en retard d√©tect√©es : {$facturesEnRetard->count()}");
        
        $retardsTraites = 0;
        $relancesEnvoyees = 0;
        
        foreach ($facturesEnRetard as $facture) {
            if (!$dryRun) {
                $ancienStatut = $facture->statut;
                $facture->statut = 'en_retard';
                $facture->save();
                
                // Historique du changement
                $facture->enregistrerHistorique(
                    'changement_statut',
                    "Passage automatique en retard",
                    "La facture #{$facture->numero_facture} est pass√©e automatiquement en retard (√©ch√©ance d√©pass√©e)",
                    ['statut' => $ancienStatut],
                    ['statut' => 'en_retard'],
                    [
                        'jours_retard' => $facture->jours_retard,
                        'montant_concerne' => $facture->montant_ttc,
                        'traitement_automatique' => true
                    ]
                );
                
                $retardsTraites++;
            }
            
            // Envoi relance
            if ($notify && !$dryRun) {
                Mail::to($facture->client->email)->send(new RelanceRetardMail($facture));
                $relancesEnvoyees++;
            }
            
            $this->line("  üö® Facture #{$facture->numero_facture} - {$facture->jours_retard} jours - {$facture->montant_ttc}‚Ç¨");
        }
        
        // =======================================
        // R√âSUM√â DU TRAITEMENT
        // =======================================
        
        if ($dryRun) {
            $this->warn("üîç Mode DRY-RUN : Aucune modification appliqu√©e");
        } else {
            $this->info("‚úÖ Traitement termin√© :");
            $this->info("   üìÖ Rappels d'√©ch√©ance : {$facturesPreEcheance->count()}");
            $this->info("   üö® Retards trait√©s : {$retardsTraites}");
            if ($notify) {
                $this->info("   üìß Relances envoy√©es : {$relancesEnvoyees}");
            }
        }
        
        // Programmation de la prochaine ex√©cution
        $this->info("‚è∞ Prochaine ex√©cution recommand√©e : demain √† 09:00");
    }
}
```

## üí∞ M√©thodes de Marquage de Paiement

### marquerPayee() - M√©thode Principale

```php
/**
 * Marquer une facture comme pay√©e avec tra√ßabilit√© compl√®te
 * 
 * @param string|null $modePaiement Mode de paiement utilis√©
 * @param string|null $reference R√©f√©rence bancaire ou num√©ro de transaction
 * @param \DateTime|null $datePaiement Date effective (par d√©faut aujourd'hui)
 * @return bool Succ√®s de l'op√©ration
 */
public function marquerPayee(
    ?string $modePaiement = null, 
    ?string $reference = null,
    ?\DateTime $datePaiement = null
): bool {
    // =======================================
    // VALIDATIONS PR√âALABLES
    // =======================================
    
    if ($this->statut === 'payee') {
        throw new \Exception("La facture #{$this->numero_facture} est d√©j√† marqu√©e comme pay√©e");
    }
    
    if ($this->statut === 'annulee') {
        throw new \Exception("Impossible de marquer comme pay√©e une facture annul√©e");
    }
    
    // =======================================
    // SAUVEGARDE DE L'√âTAT PR√âC√âDENT
    // =======================================
    
    $ancienStatut = $this->statut;
    $ancienneDatePaiement = $this->date_paiement;
    $ancienModePaiement = $this->mode_paiement;
    $ancienneReference = $this->reference_paiement;
    
    // =======================================
    // MISE √Ä JOUR DES CHAMPS DE PAIEMENT
    // =======================================
    
    $this->statut = 'payee';
    $this->date_paiement = $datePaiement ? $datePaiement->toDateString() : now()->toDateString();
    $this->mode_paiement = $modePaiement;
    $this->reference_paiement = $reference;
    
    $result = $this->save();
    
    if ($result) {
        // =======================================
        // HISTORIQUE D√âTAILL√â
        // =======================================
        
        $this->enregistrerHistorique(
            'changement_statut',
            "Facture marqu√©e comme pay√©e",
            "La facture #{$this->numero_facture} a √©t√© marqu√©e comme pay√©e" . 
            ($modePaiement ? " par {$modePaiement}" : ""),
            [
                'statut' => $ancienStatut,
                'date_paiement' => $ancienneDatePaiement,
                'mode_paiement' => $ancienModePaiement,
                'reference_paiement' => $ancienneReference
            ],
            [
                'statut' => 'payee',
                'date_paiement' => $this->date_paiement,
                'mode_paiement' => $modePaiement,
                'reference_paiement' => $reference
            ],
            [
                'montant_paye' => $this->montant_ttc,
                'delai_paiement' => $this->date_facture->diffInDays($this->date_paiement),
                'etait_en_retard' => $ancienStatut === 'en_retard',
                'jours_retard' => $ancienStatut === 'en_retard' ? $this->jours_retard : 0
            ]
        );
        
        // =======================================
        // NOTIFICATIONS AUTOMATIQUES
        // =======================================
        
        // Notification aux administrateurs
        $this->envoyerNotificationPaiement($modePaiement, $reference);
        
        // Confirmation au client (optionnel)
        if (config('factures.confirmer_paiement_client', false)) {
            Mail::to($this->client->email)->send(
                new ConfirmationPaiementMail($this, $modePaiement, $reference)
            );
        }
        
        // =======================================
        // INT√âGRATIONS COMPTABLES
        // =======================================
        
        if (config('factures.integration_comptable', false)) {
            $this->integrerComptabilite();
        }
    }
    
    return $result;
}
```

### marquerEnvoyee() - Gestion de l'Envoi

```php
/**
 * Marquer une facture comme envoy√©e au client
 * Met √† jour les statuts et la tra√ßabilit√© d'envoi
 */
public function marquerEnvoyee(): bool
{
    $ancienStatut = $this->statut;
    $ancienStatutEnvoi = $this->statut_envoi;
    
    // Mise √† jour des statuts
    $this->statut = 'envoyee';
    $this->statut_envoi = 'envoyee';
    $this->date_envoi_client = now();
    
    $result = $this->save();
    
    if ($result) {
        $changes = [
            'statut' => 'envoyee',
            'statut_envoi' => 'envoyee',
            'date_envoi_client' => $this->date_envoi_client->format('Y-m-d H:i:s')
        ];
        
        $original = [
            'statut' => $ancienStatut,
            'statut_envoi' => $ancienStatutEnvoi,
            'date_envoi_client' => null
        ];
        
        $this->enregistrerHistorique(
            'envoi_email',
            "Facture envoy√©e au client",
            "La facture #{$this->numero_facture} a √©t√© envoy√©e avec succ√®s au client {$this->client->nom_complet}",
            $original,
            $changes,
            [
                'email_destinataire' => $this->client->email,
                'type_envoi' => 'client',
                'pdf_inclus' => true,
                'echeance_dans' => $this->date_facture->diffInDays($this->date_echeance)
            ]
        );
        
        // Programmer le suivi automatique de l'√©ch√©ance
        $this->programmerSuiviEcheance();
    }
    
    return $result;
}

/**
 * Programmer le suivi automatique de cette facture
 */
private function programmerSuiviEcheance(): void
{
    // Job pour rappel 3 jours avant √©ch√©ance
    RappelEcheanceJob::dispatch($this->id)
                     ->delay($this->date_echeance->subDays(3));
    
    // Job pour v√©rification retard le jour de l'√©ch√©ance
    VerificationRetardJob::dispatch($this->id)
                         ->delay($this->date_echeance->addDay());
}
```

## üìë Suivi des R√©f√©rences de Paiement

### Types de R√©f√©rences Support√©s

```php
/**
 * Service de gestion des r√©f√©rences de paiement
 */
class ReferencesPaiementService
{
    /**
     * Types de r√©f√©rences de paiement reconnus
     */
    const TYPES_REFERENCES = [
        'virement' => [
            'prefixes' => ['VIR', 'VIRT', 'TRF'],
            'format' => 'VIR-YYYY-NNNNNN',
            'validation' => '/^VIR[T]?-\d{4}-\d{6,10}$/'
        ],
        'cheque' => [
            'prefixes' => ['CHQ', 'CHECK'],
            'format' => 'CHQ-NNNNNN',
            'validation' => '/^CHQ-\d{6,10}$/'
        ],
        'carte' => [
            'prefixes' => ['CB', 'CARD'],
            'format' => 'CB-XXXX-XXXX',
            'validation' => '/^CB-[A-Z0-9]{4}-[A-Z0-9]{4}$/'
        ],
        'especes' => [
            'prefixes' => ['ESP', 'CASH'],
            'format' => 'ESP-YYYY-MM-DD',
            'validation' => '/^ESP-\d{4}-\d{2}-\d{2}$/'
        ],
        'compensation' => [
            'prefixes' => ['COMP', 'OFFSET'],
            'format' => 'COMP-REF-XXXX',
            'validation' => '/^COMP-REF-[A-Z0-9]{4,10}$/'
        ]
    ];
    
    /**
     * Valider une r√©f√©rence de paiement selon son type
     */
    public function validerReference(string $reference, string $modePaiement): bool
    {
        $modeNormalise = strtolower(str_replace(' ', '_', $modePaiement));
        
        // Correspondance mode de paiement -> type de r√©f√©rence
        $correspondances = [
            'virement_bancaire' => 'virement',
            'virement' => 'virement',
            'cheque' => 'cheque',
            'ch√®que' => 'cheque',
            'carte_bancaire' => 'carte',
            'carte' => 'carte',
            'especes' => 'especes',
            'esp√®ces' => 'especes',
            'compensation' => 'compensation'
        ];
        
        $typeReference = $correspondances[$modeNormalise] ?? null;
        
        if (!$typeReference || !isset(self::TYPES_REFERENCES[$typeReference])) {
            return true; // Mode libre si type non reconnu
        }
        
        $pattern = self::TYPES_REFERENCES[$typeReference]['validation'];
        return preg_match($pattern, $reference) === 1;
    }
    
    /**
     * G√©n√©rer une r√©f√©rence automatique selon le mode de paiement
     */
    public function genererReference(string $modePaiement, Facture $facture): string
    {
        $modeNormalise = strtolower(str_replace(' ', '_', $modePaiement));
        
        return match ($modeNormalise) {
            'virement_bancaire', 'virement' => 
                sprintf('VIR-%s-%06d', date('Y'), $facture->id),
                
            'cheque', 'ch√®que' => 
                sprintf('CHQ-%06d', $facture->id),
                
            'carte_bancaire', 'carte' => 
                sprintf('CB-%04d-%04d', date('ym'), $facture->id),
                
            'especes', 'esp√®ces' => 
                sprintf('ESP-%s', date('Y-m-d')),
                
            'compensation' => 
                sprintf('COMP-REF-%04d', $facture->id),
                
            default => sprintf('PAY-%s-%04d', strtoupper(substr($modeNormalise, 0, 3)), $facture->id)
        };
    }
}
```

## üìä M√©triques et Indicateurs de Paiement

### Calculs Financiers Avanc√©s

```php
/**
 * Service de m√©triques de paiement
 */
class MetriquesPaiementService
{
    /**
     * Calculer les indicateurs de performance de paiement
     */
    public function getIndicateursPerformance(int $annee = null): array
    {
        $annee = $annee ?? date('Y');
        
        return [
            // D√©lais de paiement
            'delai_moyen_paiement' => $this->calculerDelaiMoyenPaiement($annee),
            'delai_median_paiement' => $this->calculerDelaiMedianPaiement($annee),
            
            // Taux de retard
            'taux_retard' => $this->calculerTauxRetard($annee),
            'montant_retards' => $this->calculerMontantRetards($annee),
            
            // Modes de paiement
            'repartition_modes_paiement' => $this->getRepartitionModesPaiement($annee),
            
            // √âvolution temporelle
            'evolution_mensuelle' => $this->getEvolutionMensuelle($annee),
            
            // Clients probl√©matiques
            'clients_retardataires' => $this->getClientsRetardataires($annee),
        ];
    }
    
    private function calculerDelaiMoyenPaiement(int $annee): float
    {
        return Facture::where('statut', 'payee')
                     ->whereYear('date_paiement', $annee)
                     ->selectRaw('AVG(DATEDIFF(date_paiement, date_facture)) as delai_moyen')
                     ->value('delai_moyen') ?? 0;
    }
    
    private function calculerTauxRetard(int $annee): float
    {
        $totalFactures = Facture::whereYear('date_facture', $annee)
                               ->whereIn('statut', ['payee', 'en_retard'])
                               ->count();
        
        if ($totalFactures === 0) return 0;
        
        $facturesEnRetard = Facture::whereYear('date_facture', $annee)
                                  ->where(function($query) {
                                      $query->where('statut', 'en_retard')
                                            ->orWhere(function($q) {
                                                $q->where('statut', 'payee')
                                                  ->whereRaw('date_paiement > date_echeance');
                                            });
                                  })
                                  ->count();
        
        return round(($facturesEnRetard / $totalFactures) * 100, 2);
    }
    
    private function getRepartitionModesPaiement(int $annee): array
    {
        return Facture::where('statut', 'payee')
                     ->whereYear('date_paiement', $annee)
                     ->groupBy('mode_paiement')
                     ->selectRaw('mode_paiement, COUNT(*) as nombre, SUM(montant_ttc) as montant_total')
                     ->orderBy('montant_total', 'desc')
                     ->get()
                     ->toArray();
    }
}
```

## üìã R√©sum√© de la Gestion des Paiements

### Fonctionnalit√©s Cl√©s

1. **üìä Statuts Enrichis** : 6 statuts vs 4 pour les devis (+50%)
2. **‚è∞ Calcul Automatique** : D√©tection des retards par cron job quotidien
3. **üí∞ Tra√ßabilit√© Compl√®te** : Date, mode et r√©f√©rence de paiement
4. **üìß Notifications Automatiques** : Rappels et relances intelligents
5. **üîç M√©triques Avanc√©es** : Indicateurs de performance financi√®re
6. **‚öñÔ∏è Conformit√© L√©gale** : Archivage et historique d√©taill√©

### Avantages vs Syst√®me Devis

- **Suivi financier** complet absent dans les devis
- **Gestion des √©ch√©ances** avec alertes automatiques
- **Calcul des retards** et p√©nalit√©s √©ventuelles
- **R√©f√©rences de paiement** structur√©es et valid√©es
- **M√©triques de performance** pour le pilotage financier

Cette architecture garantit une gestion professionnelle et automatis√©e du cycle de paiement des factures. 
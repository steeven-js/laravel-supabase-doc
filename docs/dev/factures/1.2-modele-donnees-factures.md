# Module 1.2 : Mod√®le de Donn√©es Factures

## üìã Vue d'ensemble

Ce module documente la structure compl√®te du mod√®le de donn√©es des factures dans le Dashboard Madinia. Il couvre la table `factures` avec ses 24 champs sp√©cialis√©s, les relations avec les autres entit√©s et la m√©thode de transformation depuis les devis.

## üóÑÔ∏è Structure Table Factures

### Sch√©ma Complet de la Table

```sql
CREATE TABLE factures (
    -- Identifiants primaires
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    numero_facture VARCHAR(255) UNIQUE NOT NULL,
    
    -- Relations obligatoires
    client_id BIGINT UNSIGNED NOT NULL,
    FOREIGN KEY (client_id) REFERENCES clients(id) ON DELETE CASCADE,
    
    -- Relations optionnelles
    devis_id BIGINT UNSIGNED NULL,
    FOREIGN KEY (devis_id) REFERENCES devis(id) ON DELETE CASCADE,
    administrateur_id BIGINT UNSIGNED NULL,
    FOREIGN KEY (administrateur_id) REFERENCES users(id) ON DELETE SET NULL,
    
    -- Dates obligatoires
    date_facture DATE NOT NULL,
    date_echeance DATE NOT NULL,
    
    -- Statuts m√©tier (6 statuts vs 4 pour devis)
    statut ENUM('brouillon', 'en_attente', 'envoyee', 'payee', 'en_retard', 'annulee') 
           DEFAULT 'brouillon',
    statut_envoi ENUM('non_envoyee', 'envoyee', 'echec_envoi') 
                 DEFAULT 'non_envoyee'
                 COMMENT 'Statut d\'envoi de la facture au client',
    
    -- Contenu commercial
    objet VARCHAR(255) NOT NULL,
    description TEXT NULL,
    
    -- Montants financiers (calculs automatiques)
    montant_ht DECIMAL(10,2) DEFAULT 0.00,
    taux_tva DECIMAL(5,2) DEFAULT 8.5,
    montant_tva DECIMAL(10,2) DEFAULT 0.00,
    montant_ttc DECIMAL(10,2) DEFAULT 0.00,
    
    -- Conditions et notes
    conditions_paiement TEXT NULL,
    notes TEXT NULL,
    
    -- === CHAMPS SP√âCIFIQUES AUX FACTURES ===
    -- Gestion des paiements
    date_paiement DATE NULL,
    mode_paiement VARCHAR(255) NULL,
    reference_paiement TEXT NULL,
    
    -- Gestion administrative
    archive BOOLEAN DEFAULT FALSE,
    
    -- Gestion des PDFs
    pdf_file VARCHAR(255) NULL,
    pdf_url VARCHAR(500) NULL COMMENT 'URL publique Supabase du PDF',
    
    -- Tra√ßabilit√© envois
    date_envoi_client TIMESTAMP NULL,
    date_envoi_admin TIMESTAMP NULL,
    
    -- Timestamps Laravel
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL
);
```

### Comparaison avec le Mod√®le Devis

| **Champ** | **Devis** | **Factures** | **Diff√©rence** |
|-----------|-----------|--------------|----------------|
| **Champs identiques** | 20 champs | 20 champs | Base commune |
| **Champs sp√©cifiques factures** | - | 4 champs | Paiement + archivage |
| **Total** | 20 champs | 24 champs | +4 champs (20%) |

#### Champs Sp√©cifiques aux Factures

```php
// Champs exclusifs aux factures (absents dans devis)
protected $fillable = [
    // ... champs communs (20) ...
    
    // === SP√âCIFIQUES FACTURES ===
    'date_paiement',         // Date effective du paiement
    'mode_paiement',         // Moyen utilis√© (virement, ch√®que, etc.)
    'reference_paiement',    // R√©f√©rence bancaire ou num√©ro de transaction
    'archive',               // Statut d'archivage l√©gal
];
```

## üéØ D√©finition du Mod√®le Laravel

### Classe Facture Compl√®te

```php
<?php

namespace App\Models;

use App\Traits\HasHistorique;
use App\Traits\SendsNotifications;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;

class Facture extends Model
{
    use HasHistorique, SendsNotifications;

    protected $table = 'factures';

    /**
     * Champs assignables en masse (24 champs vs 20 pour devis)
     */
    protected $fillable = [
        // Identifiants
        'numero_facture',
        'devis_id',
        'client_id',
        'administrateur_id',
        
        // Dates
        'date_facture',
        'date_echeance',
        
        // Statuts
        'statut',
        'statut_envoi',
        
        // Contenu
        'objet',
        'description',
        
        // Montants
        'montant_ht',
        'taux_tva',
        'montant_tva',
        'montant_ttc',
        
        // Conditions
        'conditions_paiement',
        'notes',
        
        // === SP√âCIFIQUES FACTURES ===
        'date_paiement',         // +1
        'mode_paiement',         // +2
        'reference_paiement',    // +3
        'archive',               // +4
        
        // Fichiers
        'pdf_file',
        'pdf_url',
        
        // Tra√ßabilit√©
        'date_envoi_client',
        'date_envoi_admin',
    ];

    /**
     * Casting des attributs avec types sp√©cialis√©s
     */
    protected $casts = [
        // Dates
        'date_facture' => 'date',
        'date_echeance' => 'date',
        'date_paiement' => 'date',              // Sp√©cifique facture
        
        // Montants avec pr√©cision d√©cimale
        'montant_ht' => 'decimal:2',
        'taux_tva' => 'decimal:2',
        'montant_tva' => 'decimal:2',
        'montant_ttc' => 'decimal:2',
        
        // Booleans
        'archive' => 'boolean',                 // Sp√©cifique facture
        
        // Timestamps
        'date_envoi_client' => 'datetime',
        'date_envoi_admin' => 'datetime',
    ];

    /**
     * √âv√©nements du mod√®le
     */
    protected static function boot()
    {
        parent::boot();

        // Calcul automatique des montants avant sauvegarde
        static::saving(function ($facture) {
            if (
                $facture->isDirty(['montant_ht', 'taux_tva']) ||
                $facture->montant_tva == 0 ||
                $facture->montant_ttc == 0
            ) {
                $facture->calculerMontants();
            }
        });

        // G√©n√©ration automatique du num√©ro si absent
        static::creating(function ($facture) {
            if (empty($facture->numero_facture)) {
                $facture->numero_facture = static::genererNumeroFacture();
            }
        });
    }
}
```

## üîó Relations avec les Autres Entit√©s

### Diagramme des Relations

```mermaid
erDiagram
    FACTURES {
        bigint id PK
        string numero_facture UK
        bigint client_id FK
        bigint devis_id FK "nullable"
        bigint administrateur_id FK "nullable" 
        date date_facture
        date date_echeance
        date date_paiement "nullable"
        string mode_paiement "nullable"
        text reference_paiement "nullable"
        boolean archive
        string pdf_url "nullable"
        decimal montant_ht
        decimal montant_ttc
        enum statut
    }
    
    CLIENTS {
        bigint id PK
        string nom
        string prenom
        string email
        bigint entreprise_id FK
    }
    
    DEVIS {
        bigint id PK
        string numero_devis
        bigint client_id FK
        enum statut
    }
    
    USERS {
        bigint id PK
        string name
        string email
        string role
    }
    
    LIGNES_FACTURES {
        bigint id PK
        bigint facture_id FK
        bigint service_id FK
        decimal quantite
        decimal prix_unitaire_ht
        decimal montant_ttc
        integer ordre
    }
    
    SERVICES {
        bigint id PK
        string nom
        decimal prix_unitaire
        string unite
    }
    
    HISTORIQUE {
        bigint id PK
        string entite_type
        bigint entite_id
        string action
        text description
    }
    
    FACTURES ||--|| CLIENTS : "pour client"
    FACTURES ||--o| DEVIS : "depuis devis"
    FACTURES ||--o| USERS : "admin responsable"
    FACTURES ||--o{ LIGNES_FACTURES : "contient lignes"
    LIGNES_FACTURES ||--|| SERVICES : "r√©f√©rence service"
    FACTURES ||--o{ HISTORIQUE : "tra√ßabilit√©"
```

### Relations Laravel D√©taill√©es

```php
class Facture extends Model
{
    /**
     * Client destinataire de la facture
     * Relation obligatoire et contrainte
     */
    public function client(): BelongsTo
    {
        return $this->belongsTo(Client::class)
                    ->with('entreprise');  // Eager loading automatique
    }

    /**
     * Devis d'origine (transformation)
     * Relation optionnelle - peut √™tre null pour factures directes
     */
    public function devis(): BelongsTo
    {
        return $this->belongsTo(Devis::class);
    }

    /**
     * Administrateur responsable
     * Relation optionnelle avec protection contre la suppression
     */
    public function administrateur(): BelongsTo
    {
        return $this->belongsTo(User::class, 'administrateur_id')
                    ->select(['id', 'name', 'email']);
    }

    /**
     * Lignes de prestations factur√©es
     * Relation un-√†-plusieurs avec ordre
     */
    public function lignes(): HasMany
    {
        return $this->hasMany(LigneFacture::class)
                    ->orderBy('ordre')
                    ->with('service');  // Eager loading du service
    }

    /**
     * Historique des actions sur la facture
     * Utilise le trait HasHistorique
     */
    public function historique()
    {
        return $this->morphMany(Historique::class, 'entite')
                    ->with('user')
                    ->latest();
    }
}
```

## üõ†Ô∏è M√©thode creerDepuisDevis() D√©taill√©e

### Analyse Compl√®te de la Transformation

```php
/**
 * Cr√©er une facture compl√®te √† partir d'un devis accept√©
 * 
 * @param Devis $devis Le devis source √† transformer
 * @return Facture La nouvelle facture cr√©√©e
 * @throws \Exception Si le devis ne peut pas √™tre transform√©
 */
public static function creerDepuisDevis(Devis $devis): self
{
    // ================================================
    // PHASE 1 : VALIDATIONS PR√âALABLES
    // ================================================
    
    // V√©rifier l'√©ligibilit√© du devis
    if (!$devis->peutEtreTransformeEnFacture()) {
        throw new \Exception(
            "Le devis #{$devis->numero_devis} ne peut pas √™tre transform√© : " .
            "statut '{$devis->statut}' non autoris√©"
        );
    }
    
    // V√©rifier qu'il n'existe pas d√©j√† une facture pour ce devis
    if (static::where('devis_id', $devis->id)->exists()) {
        $factureExistante = static::where('devis_id', $devis->id)->first();
        throw new \Exception(
            "Le devis #{$devis->numero_devis} a d√©j√† √©t√© transform√© " .
            "en facture #{$factureExistante->numero_facture}"
        );
    }
    
    // ================================================
    // PHASE 2 : CHARGEMENT DES DONN√âES
    // ================================================
    
    // Charger toutes les relations n√©cessaires en une seule requ√™te
    $devis->load([
        'administrateur:id,name,email',
        'lignes.service:id,nom,description,unite',
        'client.entreprise:id,nom,nom_commercial'
    ]);
    
    // ================================================
    // PHASE 3 : CR√âATION DE LA FACTURE DE BASE
    // ================================================
    
    $facture = new self([
        // Identifiants
        'numero_facture' => self::genererNumeroFacture(),
        'devis_id' => $devis->id,
        'client_id' => $devis->client_id,
        'administrateur_id' => $devis->administrateur?->id,
        
        // Dates avec calcul d'√©ch√©ance
        'date_facture' => now()->toDateString(),
        'date_echeance' => now()->addDays(30)->toDateString(),
        
        // Statut initial
        'statut' => 'brouillon',
        'statut_envoi' => 'non_envoyee',
        
        // Contenu commercial (copie exacte)
        'objet' => $devis->objet,
        'description' => $devis->description,
        'notes' => $devis->notes,
        
        // Conditions adapt√©es pour facture
        'conditions_paiement' => $devis->conditions ?? 'Paiement √† 30 jours par virement bancaire',
        
        // Montants initialis√©s √† z√©ro (seront recalcul√©s)
        'montant_ht' => 0,
        'taux_tva' => 0,
        'montant_tva' => 0,
        'montant_ttc' => 0,
    ]);
    
    // Sauvegarder la facture de base
    $facture->save();
    
    // ================================================
    // PHASE 4 : COPIE DES LIGNES DE PRESTATIONS
    // ================================================
    
    $lignesCopiees = 0;
    
    foreach ($devis->lignes as $ligneDevis) {
        $ligneFacture = $facture->lignes()->create([
            'service_id' => $ligneDevis->service_id,
            'quantite' => $ligneDevis->quantite,
            'prix_unitaire_ht' => $ligneDevis->prix_unitaire_ht,
            'taux_tva' => $ligneDevis->taux_tva,
            'ordre' => $ligneDevis->ordre,
            'description_personnalisee' => $ligneDevis->description_personnalisee,
            // montant_ht, montant_tva, montant_ttc calcul√©s automatiquement via boot()
        ]);
        
        $lignesCopiees++;
    }
    
    // ================================================
    // PHASE 5 : RECALCUL DES TOTAUX
    // ================================================
    
    // Recalculer tous les montants √† partir des lignes
    $facture->calculerMontants();
    $facture->save();
    
    // ================================================
    // PHASE 6 : TRA√áABILIT√â ET HISTORIQUE
    // ================================================
    
    // Enregistrer la transformation dans l'historique du devis
    $devis->enregistrerHistorique(
        'transformation',
        "Transformation en facture",
        "Le devis #{$devis->numero_devis} a √©t√© transform√© en facture #{$facture->numero_facture}",
        null, // Pas d'ancien √©tat
        null, // Pas de nouvel √©tat (action ponctuelle)
        [
            'facture_id' => $facture->id,
            'numero_facture' => $facture->numero_facture,
            'date_transformation' => now()->format('Y-m-d H:i:s'),
            'lignes_copiees' => $lignesCopiees,
            'montant_transforme' => $facture->montant_ttc
        ]
    );
    
    // Enregistrer la cr√©ation dans l'historique de la facture
    $facture->enregistrerHistorique(
        'creation',
        "Cr√©ation depuis devis",
        "Facture cr√©√©e automatiquement depuis le devis #{$devis->numero_devis}",
        null,
        null,
        [
            'devis_id' => $devis->id,
            'numero_devis' => $devis->numero_devis,
            'methode_creation' => 'transformation_devis',
            'lignes_importees' => $lignesCopiees
        ]
    );
    
    return $facture;
}
```

## üìä Scopes et Requ√™tes Sp√©cialis√©es

### Scopes M√©tier pour les Factures

```php
class Facture extends Model
{
    /**
     * Factures non archiv√©es (actives)
     */
    public function scopeActives($query)
    {
        return $query->where('archive', false);
    }

    /**
     * Factures par statut sp√©cifique
     */
    public function scopeParStatut($query, $statut)
    {
        return $query->where('statut', $statut);
    }

    /**
     * Factures en retard (√©ch√©ance d√©pass√©e)
     */
    public function scopeEnRetard($query)
    {
        return $query->where('date_echeance', '<', now()->toDateString())
                    ->whereIn('statut', ['envoyee', 'en_attente', 'brouillon']);
    }

    /**
     * Factures d'un client sp√©cifique
     */
    public function scopeParClient($query, $clientId)
    {
        return $query->where('client_id', $clientId);
    }

    /**
     * Factures d'une p√©riode donn√©e
     */
    public function scopeParPeriode($query, $dateDebut, $dateFin)
    {
        return $query->whereBetween('date_facture', [$dateDebut, $dateFin]);
    }

    /**
     * Factures pay√©es avec d√©lai de paiement
     */
    public function scopePayeesAvecDelai($query)
    {
        return $query->where('statut', 'payee')
                    ->whereNotNull('date_paiement')
                    ->selectRaw('*, DATEDIFF(date_paiement, date_facture) as delai_paiement');
    }

    /**
     * Factures cr√©√©es depuis un devis
     */
    public function scopeDepuisDevis($query)
    {
        return $query->whereNotNull('devis_id')
                    ->with('devis:id,numero_devis,statut');
    }
}
```

## üìã R√©sum√© du Mod√®le de Donn√©es

### Caract√©ristiques Principales

1. **üî¢ Structure √âtendue** : 24 champs vs 20 pour les devis (+20%)
2. **üí∞ Sp√©cialisation Paiement** : 4 champs d√©di√©s au suivi financier
3. **üîó Relations Riches** : 5 relations principales avec eager loading
4. **üéØ M√©thodes M√©tier** : Transformation, calculs, gestion des retards
5. **üìä Scopes Avanc√©s** : 7 scopes pour requ√™tes sp√©cialis√©es
6. **‚ö° Performances** : Calculs automatiques et optimisations

Cette architecture robuste garantit une gestion compl√®te du cycle de facturation tout en maintenant la compatibilit√© avec le syst√®me de devis existant. 
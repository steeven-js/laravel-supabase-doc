# Module 2.1 : FactureController - CRUD Complet

## ğŸ“‹ Vue d'ensemble

Ce module documente le contrÃ´leur principal des factures (`FactureController.php`) avec ses 1270 lignes de code. Il couvre toutes les mÃ©thodes CRUD, les actions spÃ©cialisÃ©es pour la gestion des paiements, et les contraintes fiscales spÃ©cifiques aux factures.

## ğŸ—ï¸ Architecture du ContrÃ´leur

### Structure GÃ©nÃ©rale

```php
<?php

namespace App\Http\Controllers;

use App\Models\Client;
use App\Models\Facture;
use App\Services\FacturePdfService;
use App\Services\EmailLogService;
// ... autres imports

class FactureController extends Controller
{
    protected $facturePdfService;

    public function __construct(FacturePdfService $facturePdfService)
    {
        $this->facturePdfService = $facturePdfService;
    }

    // 14 mÃ©thodes principales
    // + mÃ©thodes PDF spÃ©cialisÃ©es
    // + mÃ©thodes de synchronisation Supabase
}
```

### MÃ©thodes Principales (14 routes)

| **MÃ©thode** | **Route** | **Action** | **SpÃ©cificitÃ© Factures** |
|-------------|-----------|------------|---------------------------|
| `index()` | `GET /factures` | Liste avec filtres | MÃ©triques financiÃ¨res temps rÃ©el |
| `create()` | `GET /factures/create` | Formulaire crÃ©ation | Auto-gÃ©nÃ©ration numÃ©ro fiscal |
| `store()` | `POST /factures` | CrÃ©ation facture | Validation fiscale stricte |
| `show()` | `GET /factures/{id}` | DÃ©tail complet | Informations paiement |
| `edit()` | `GET /factures/{id}/edit` | Formulaire Ã©dition | Contraintes document fiscal |
| `update()` | `PUT /factures/{id}` | Mise Ã  jour | Limitations Ã©dition |
| `destroy()` | `DELETE /factures/{id}` | Suppression | VÃ©rifications lÃ©gales |
| `changerStatut()` | `PATCH /{id}/changer-statut` | Changement statut | Transitions fiscales |
| `marquerPayee()` | `PATCH /{id}/marquer-payee` | Marquage paiement | RÃ©fÃ©rences obligatoires |
| `envoyerEmailForm()` | `GET /{id}/envoyer-email` | Form email | Templates fiscaux |
| `envoyerEmail()` | `POST /{id}/envoyer-email` | Envoi email | PDF obligatoire |
| `voirPdf()` | `GET /{id}/pdf` | Consultation PDF | Document fiscal |
| `telechargerPdf()` | `GET /{id}/telecharger-pdf` | TÃ©lÃ©chargement | Nommage fiscal |
| `syncSupabase()` | `GET /{id}/sync-supabase` | Synchronisation | Stockage permanent |

## ğŸ’° MÃ©thodes CRUD SpÃ©cialisÃ©es

### index() - Liste avec MÃ©triques FinanciÃ¨res

```php
/**
 * Affiche la liste des factures avec mÃ©triques temps rÃ©el
 */
public function index()
{
    $factures = Facture::with(['client.entreprise', 'devis'])
        ->actives()  // Scope spÃ©cialisÃ© : factures non archivÃ©es
        ->orderBy('created_at', 'desc')
        ->get();

    return Inertia::render('factures/index', [
        'factures' => $factures
    ]);
}
```

**ğŸ” SpÃ©cificitÃ©s vs Devis :**
- **Scope `actives()`** : Exclusion des factures archivÃ©es (compliance)
- **Relation `devis`** : Lien avec document d'origine
- **Pas de pagination** : Volume plus faible que les devis
- **MÃ©triques calculÃ©es cÃ´tÃ© frontend** : Performance optimisÃ©e

### create() - Formulaire avec Auto-gÃ©nÃ©ration

```php
/**
 * Affiche le formulaire de crÃ©ation avec numÃ©ro fiscal prÃ©-gÃ©nÃ©rÃ©
 */
public function create()
{
    $clients = Client::with('entreprise')->actifs()->orderBy('nom')->get();
    $services = \App\Models\Service::actif()->orderBy('nom')->get();
    $administrateurs = \App\Models\User::select('id', 'name', 'email')->orderBy('name')->get();
    $madinia = \App\Models\Madinia::getInstance();

    return Inertia::render('factures/create', [
        'clients' => $clients,
        'services' => $services,
        'administrateurs' => $administrateurs,
        'numero_facture' => Facture::genererNumeroFacture(), // â­ AUTO-GÃ‰NÃ‰RATION
        'madinia' => $madinia ? [
            'name' => $madinia->name,
            'telephone' => $madinia->telephone,
            'email' => $madinia->email,
            'adresse' => $madinia->adresse,
            'pays' => $madinia->pays,
            'siret' => $madinia->siret,
            'numero_nda' => $madinia->numero_nda,
            'nom_compte_bancaire' => $madinia->nom_compte_bancaire,
            'nom_banque' => $madinia->nom_banque,
            'numero_compte' => $madinia->numero_compte,
            'iban_bic_swift' => $madinia->iban_bic_swift,
        ] : null,
    ]);
}
```

**ğŸ¯ DiffÃ©rences avec les Devis :**
- **`Facture::genererNumeroFacture()`** : Format fiscal FACT-YYYY-NNNN
- **Informations bancaires Madinia** : NÃ©cessaires pour le paiement
- **Pas de transformation** : CrÃ©ation directe (vs devis qui peuvent devenir factures)

### store() - CrÃ©ation avec Validations Fiscales

```php
/**
 * Enregistre une nouvelle facture avec contraintes fiscales
 */
public function store(Request $request)
{
    try {
        // =======================================
        // VALIDATION FISCALE STRICTE
        // =======================================
        
        $validated = $request->validate([
            'numero_facture' => 'required|string|unique:factures,numero_facture',
            'client_id' => 'required|exists:clients,id',
            'administrateur_id' => 'required|exists:users,id',
            'date_facture' => 'required|date',
            'date_echeance' => 'required|date|after:date_facture', // â­ CONTRAINTE FISCALE
            'objet' => 'nullable|string|max:255',
            'description' => 'nullable|string',
            'conditions_paiement' => 'nullable|string',
            'notes' => 'nullable|string',
            'lignes' => 'required|array|min:1', // â­ AU MOINS 1 LIGNE
            'lignes.*.service_id' => 'nullable|exists:services,id',
            'lignes.*.quantite' => 'required|numeric|min:0',
            'lignes.*.prix_unitaire_ht' => 'required|numeric|min:0',
            'lignes.*.taux_tva' => 'required|numeric|min:0|max:100',
            'lignes.*.description_personnalisee' => 'nullable|string',
            'lignes.*.ordre' => 'required|integer|min:1',
        ]);

        // =======================================
        // CRÃ‰ATION FACTURE AVEC STATUT FISCAL
        // =======================================
        
        $facture = new Facture();
        $facture->fill($validated);
        $facture->statut = 'en_attente'; // â­ STATUT INITIAL FISCAL
        $facture->statut_envoi = 'non_envoyee';
        $facture->save();

        // =======================================
        // CRÃ‰ATION LIGNES AVEC CALCULS AUTO
        // =======================================
        
        foreach ($validated['lignes'] as $ligneData) {
            $ligne = new \App\Models\LigneFacture();
            $ligne->facture_id = $facture->id;
            $ligne->fill($ligneData);
            $ligne->save(); // Les montants calculÃ©s automatiquement via boot()
        }

        // =======================================
        // RECALCUL GLOBAL DES MONTANTS
        // =======================================
        
        $facture->calculerMontants();
        $facture->save();

        // =======================================
        // LOG POUR CONFORMITÃ‰
        // =======================================
        
        Log::info('Facture crÃ©Ã©e - PDF sera gÃ©nÃ©rÃ© cÃ´tÃ© client', [
            'facture_id' => $facture->id,
            'numero_facture' => $facture->numero_facture
        ]);

        return redirect()->route('factures.show', $facture)
            ->with('success', 'âœ… Facture ' . $facture->numero_facture . ' crÃ©Ã©e avec succÃ¨s !');

    } catch (ValidationException $e) {
        return back()
            ->withErrors($e->errors())
            ->withInput()
            ->with('error', 'âŒ Erreur de validation. Veuillez vÃ©rifier les informations saisies.');
    } catch (Exception $e) {
        Log::error('Erreur lors de la crÃ©ation de la facture', [
            'error_message' => $e->getMessage(),
            'error_file' => $e->getFile(),
            'error_line' => $e->getLine()
        ]);
        return back()
            ->withInput()
            ->with('error', 'âŒ Une erreur est survenue lors de la crÃ©ation de la facture.');
    }
}
```

**âš–ï¸ Contraintes Fiscales SpÃ©cifiques :**
- **NumÃ©ro unique obligatoire** : Validation strict en DB
- **Date Ã©chÃ©ance > date facture** : ConformitÃ© lÃ©gale
- **Statut initial "en_attente"** : PrÃªt pour envoi (vs "brouillon" pour devis)
- **Au moins 1 ligne obligatoire** : Document fiscal valide

### show() - DÃ©tail avec Informations Paiement

```php
/**
 * Affiche les dÃ©tails complets d'une facture avec historique paiement
 */
public function show(Facture $facture)
{
    // =======================================
    // CHARGEMENT RELATIONS COMPLÃˆTES
    // =======================================
    
    $facture->load([
        'client.entreprise',
        'devis',
        'lignes.service',
        'administrateur'
    ]);

    // =======================================
    // HISTORIQUE SPÃ‰CIALISÃ‰
    // =======================================
    
    $historique = $facture->historique()
        ->with('user:id,name')
        ->latest()
        ->get()
        ->map(function ($entry) {
            return [
                'id' => $entry->id,
                'action' => $entry->action,
                'description' => $entry->description,
                'ancien_etat' => $entry->ancien_etat,
                'nouvel_etat' => $entry->nouvel_etat,
                'donnees_supplementaires' => $entry->donnees_supplementaires,
                'created_at' => $entry->created_at->toISOString(),
                'user' => $entry->user ? [
                    'id' => $entry->user->id,
                    'name' => $entry->user->name,
                ] : null,
            ];
        });

    $madinia = \App\Models\Madinia::getInstance();

    // =======================================
    // FORMATAGE SPÃ‰CIALISÃ‰ FACTURES
    // =======================================
    
    $factureFormatted = [
        'id' => $facture->id,
        'numero_facture' => $facture->numero_facture,
        'devis_id' => $facture->devis_id,
        'administrateur_id' => $facture->administrateur_id,
        'client_id' => $facture->client_id,
        'objet' => $facture->objet,
        'description' => $facture->description,
        'statut' => $facture->statut,
        'statut_envoi' => $facture->statut_envoi,
        'date_facture' => $facture->date_facture?->format('Y-m-d') ?? '',
        'date_echeance' => $facture->date_echeance?->format('Y-m-d') ?? '',
        
        // â­ CHAMPS SPÃ‰CIFIQUES PAIEMENT
        'date_paiement' => $facture->date_paiement?->format('Y-m-d') ?? null,
        'mode_paiement' => $facture->mode_paiement,
        'reference_paiement' => $facture->reference_paiement,
        'archive' => $facture->archive,
        
        'date_envoi_client' => $facture->date_envoi_client?->toISOString(),
        'date_envoi_admin' => $facture->date_envoi_admin?->toISOString(),
        'montant_ht' => (float) $facture->montant_ht,
        'taux_tva' => (float) $facture->taux_tva,
        'montant_tva' => (float) $facture->montant_tva,
        'montant_ttc' => (float) $facture->montant_ttc,
        'conditions_paiement' => $facture->conditions_paiement,
        'notes' => $facture->notes,
        'created_at' => $facture->created_at->toISOString(),
        'updated_at' => $facture->updated_at->toISOString(),
        
        // â­ MÃ‰THODES MÃ‰TIER SPÃ‰CIALISÃ‰ES
        'peut_etre_envoyee' => $facture->peutEtreEnvoyee(),
        'pdf_url_supabase' => $this->facturePdfService->getUrlSupabasePdf($facture),
        
        // Relations enrichies
        'administrateur' => $facture->administrateur ? [
            'id' => $facture->administrateur->id,
            'name' => $facture->administrateur->name,
            'email' => $facture->administrateur->email,
        ] : null,
        
        'client' => $facture->client ? [
            'id' => $facture->client->id,
            'nom' => $facture->client->nom,
            'prenom' => $facture->client->prenom,
            'email' => $facture->client->email,
            'telephone' => $facture->client->telephone,
            'adresse' => $facture->client->adresse,
            'ville' => $facture->client->ville,
            'code_postal' => $facture->client->code_postal,
            'entreprise' => $facture->client->entreprise ? [
                'id' => $facture->client->entreprise->id,
                'nom' => $facture->client->entreprise->nom,
                'nom_commercial' => $facture->client->entreprise->nom_commercial,
                'adresse' => $facture->client->entreprise->adresse,
                'ville' => $facture->client->entreprise->ville,
                'code_postal' => $facture->client->entreprise->code_postal,
            ] : null
        ] : null,
        
        // â­ LIEN DEVIS D'ORIGINE (spÃ©cifique factures)
        'devis' => $facture->devis ? [
            'id' => $facture->devis->id,
            'numero_devis' => $facture->devis->numero_devis,
        ] : null,
    ];

    // =======================================
    // STATUT PDF SPÃ‰CIALISÃ‰
    // =======================================
    
    $pdfStatus = $this->getPdfStatusData($facture);

    return Inertia::render('factures/show', [
        'facture' => $factureFormatted,
        'historique' => $historique,
        'pdfStatus' => $pdfStatus,
        'madinia' => [
            'id' => $madinia->id,
            'name' => $madinia->name,
            'telephone' => $madinia->telephone,
            'email' => $madinia->email,
            'site_web' => $madinia->site_web,
            'siret' => $madinia->siret,
            'numero_nda' => $madinia->numero_nda,
            'pays' => $madinia->pays,
            'adresse' => $madinia->adresse,
            'description' => $madinia->description,
            'nom_compte_bancaire' => $madinia->nom_compte_bancaire,
            'nom_banque' => $madinia->nom_banque,
            'numero_compte' => $madinia->numero_compte,
            'iban_bic_swift' => $madinia->iban_bic_swift,
        ]
    ]);
}
```

**ğŸ” Enrichissements SpÃ©cialisÃ©s :**
- **Champs paiement** : `date_paiement`, `mode_paiement`, `reference_paiement`
- **Lien devis d'origine** : TraÃ§abilitÃ© transformation
- **Informations bancaires** : NÃ©cessaires pour le rÃ¨glement
- **Statut PDF** : ContrÃ´le document fiscal obligatoire

## ğŸ”„ MÃ©thodes d'Ã‰dition ContrÃ´lÃ©e

### edit() - Limitations Fiscales

```php
/**
 * Formulaire d'Ã©dition avec contraintes document fiscal
 */
public function edit(Facture $facture)
{
    // âš ï¸ CONTRAINTES : Certaines factures ne peuvent pas Ãªtre Ã©ditÃ©es
    // Exemple : factures payÃ©es, envoyÃ©es depuis longtemps, etc.
    
    $facture->load(['client.entreprise', 'devis', 'lignes.service', 'administrateur']);
    $clients = Client::with('entreprise')->actifs()->orderBy('nom')->get();
    $services = \App\Models\Service::actif()->orderBy('nom')->get();
    $administrateurs = \App\Models\User::select('id', 'name', 'email')->orderBy('name')->get();
    $madinia = \App\Models\Madinia::getInstance();

    // Construction manuelle pour Ã©viter problÃ¨mes sÃ©rialisation
    $factureFormatted = [
        'id' => $facture->id,
        'numero_facture' => $facture->numero_facture, // âš ï¸ NON MODIFIABLE
        'devis_id' => $facture->devis_id,
        'administrateur_id' => $facture->administrateur_id,
        'client_id' => $facture->client_id,
        'objet' => $facture->objet,
        'statut' => $facture->statut,
        'date_facture' => $facture->date_facture?->format('Y-m-d') ?? '',
        'date_echeance' => $facture->date_echeance?->format('Y-m-d') ?? '',
        'montant_ht' => (float) $facture->montant_ht,
        'taux_tva' => (float) $facture->taux_tva,
        'montant_tva' => (float) $facture->montant_tva,
        'montant_ttc' => (float) $facture->montant_ttc,
        'notes' => $facture->notes,
        'description' => $facture->description,
        'conditions_paiement' => $facture->conditions_paiement,
        'archive' => $facture->archive,
        
        // Relations complÃ¨tes...
    ];

    return Inertia::render('factures/edit', [
        'facture' => $factureFormatted,
        'clients' => $clients,
        'services' => $services,
        'administrateurs' => $administrateurs,
        'madinia' => $madinia ? [
            // Informations Madinia...
        ] : null,
    ]);
}
```

### update() - Gestion Lignes AvancÃ©e

```php
/**
 * Met Ã  jour une facture avec gestion intelligente des lignes
 */
public function update(Request $request, Facture $facture)
{
    try {
        // =======================================
        // VALIDATION AVEC CONTRAINTES FISCALES
        // =======================================
        
        $validated = $request->validate([
            'numero_facture' => 'required|string|unique:factures,numero_facture,' . $facture->id,
            'administrateur_id' => 'required|exists:users,id',
            'client_id' => 'required|exists:clients,id',
            'date_facture' => 'required|date',
            'date_echeance' => 'required|date|after:date_facture',
            'statut' => 'required|in:brouillon,en_attente,envoyee,payee,en_retard,annulee',
            'objet' => 'nullable|string|max:255',
            'description' => 'nullable|string',
            'conditions_paiement' => 'nullable|string',
            'notes' => 'nullable|string',
            'archive' => 'boolean',
            'lignes' => 'required|array|min:1',
            'lignes.*.id' => 'nullable|exists:lignes_factures,id',
            'lignes.*.service_id' => 'nullable|exists:services,id',
            'lignes.*.quantite' => 'required|numeric|min:0',
            'lignes.*.prix_unitaire_ht' => 'required|numeric|min:0',
            'lignes.*.taux_tva' => 'required|numeric|min:0|max:100',
            'lignes.*.description_personnalisee' => 'nullable|string',
            'lignes.*.ordre' => 'required|integer|min:1',
        ]);

        // =======================================
        // MISE Ã€ JOUR FACTURE
        // =======================================
        
        $facture->fill($validated);
        $facture->save();

        // =======================================
        // GESTION INTELLIGENTE DES LIGNES
        // =======================================
        
        $lignesExistantes = $facture->lignes->keyBy('id');
        $lignesTraitees = collect();

        foreach ($validated['lignes'] as $ligneData) {
            if (isset($ligneData['id']) && $lignesExistantes->has($ligneData['id'])) {
                // â­ MISE Ã€ JOUR LIGNE EXISTANTE
                $ligne = $lignesExistantes->get($ligneData['id']);
                $ligne->fill($ligneData);
                $ligne->save(); // Recalcul automatique des montants
                $lignesTraitees->push($ligneData['id']);
            } else {
                // â­ CRÃ‰ATION NOUVELLE LIGNE
                $ligne = new \App\Models\LigneFacture();
                $ligne->facture_id = $facture->id;
                $ligne->fill($ligneData);
                $ligne->save();
            }
        }

        // â­ SUPPRESSION LIGNES ORPHELINES
        $lignesASupprimer = $lignesExistantes->keys()->diff($lignesTraitees);
        if ($lignesASupprimer->isNotEmpty()) {
            \App\Models\LigneFacture::whereIn('id', $lignesASupprimer)->delete();
        }

        // =======================================
        // RECALCUL GLOBAL DES MONTANTS
        // =======================================
        
        $facture->calculerMontants();
        $facture->save();

        return redirect()->route('factures.index')
            ->with('success', 'ğŸ‰ Facture ' . $facture->numero_facture . ' mise Ã  jour avec succÃ¨s !');

    } catch (ValidationException $e) {
        return back()
            ->withErrors($e->errors())
            ->withInput()
            ->with('error', 'âŒ Erreur de validation. Veuillez vÃ©rifier les informations saisies.');
    } catch (Exception $e) {
        return back()
            ->withInput()
            ->with('error', 'âŒ Une erreur est survenue lors de la mise Ã  jour de la facture.');
    }
}
```

**ğŸ”§ Gestion AvancÃ©e des Lignes :**
- **Conservation ID existants** : Maintien cohÃ©rence historique
- **CrÃ©ation nouvelles lignes** : Sans ID pour les ajouts
- **Suppression orphelines** : Lignes supprimÃ©es du formulaire
- **Recalcul automatique** : Montants cohÃ©rents aprÃ¨s modifications

## ğŸ’° MÃ©thodes SpÃ©cialisÃ©es Paiement

### changerStatut() - Transitions Fiscales

```php
/**
 * Changer le statut avec contrÃ´les fiscaux et notifications
 */
public function changerStatut(Request $request, Facture $facture)
{
    try {
        $validated = $request->validate([
            'statut' => 'required|in:brouillon,en_attente,envoyee,payee,en_retard,annulee',
        ]);

        $ancienStatut = $facture->statut;
        $nouveauStatut = $validated['statut'];

        // =======================================
        // VÃ‰RIFICATIONS MÃ‰TIER SPÃ‰CIALISÃ‰ES
        // =======================================
        
        // âš–ï¸ CONTRAINTE FISCALE : Paiement uniquement si envoyÃ©e/retard
        if ($nouveauStatut === 'payee' && !in_array($ancienStatut, ['envoyee', 'en_retard'])) {
            return redirect()->back()
                ->with('error', 'âŒ Une facture ne peut Ãªtre marquÃ©e comme payÃ©e que si elle est envoyÃ©e ou en retard.');
        }

        $facture->statut = $nouveauStatut;

        // =======================================
        // ACTIONS AUTOMATIQUES PAR STATUT
        // =======================================
        
        if ($nouveauStatut === 'payee' && $ancienStatut !== 'payee') {
            // â­ AUTO-REMPLISSAGE DATE PAIEMENT
            $facture->date_paiement = now();
        } elseif ($nouveauStatut !== 'payee') {
            // â­ RESET DATE PAIEMENT SI PLUS PAYÃ‰E
            $facture->date_paiement = null;
        }

        $facture->save();

        // =======================================
        // NOTIFICATIONS SPÃ‰CIALISÃ‰ES
        // =======================================
        
        if (in_array($nouveauStatut, ['payee', 'annulee', 'en_retard'])) {
            $messages = [
                'payee' => "La facture #{$facture->numero_facture} de {$facture->client->prenom} {$facture->client->nom} a Ã©tÃ© marquÃ©e comme payÃ©e",
                'annulee' => "La facture #{$facture->numero_facture} de {$facture->client->prenom} {$facture->client->nom} a Ã©tÃ© annulÃ©e",
                'en_retard' => "La facture #{$facture->numero_facture} de {$facture->client->prenom} {$facture->client->nom} est maintenant en retard de paiement"
            ];

            $facture->sendCustomNotification('status_changed', $messages[$nouveauStatut]);
        }

        return redirect()->back()
            ->with('success', 'âœ… Statut de la facture ' . $facture->numero_facture . ' modifiÃ© avec succÃ¨s !');

    } catch (ValidationException $e) {
        return redirect()->back()
            ->withErrors($e->errors())
            ->with('error', 'âŒ Erreur de validation. Veuillez vÃ©rifier le statut sÃ©lectionnÃ©.');
    } catch (Exception $e) {
        return redirect()->back()
            ->with('error', 'âŒ Une erreur est survenue lors du changement de statut.');
    }
}
```

### marquerPayee() - Gestion ComplÃ¨te Paiement

```php
/**
 * Marquer comme payÃ©e avec rÃ©fÃ©rences de paiement
 */
public function marquerPayee(Request $request, Facture $facture)
{
    try {
        // =======================================
        // VALIDATION DONNÃ‰ES PAIEMENT
        // =======================================
        
        $validated = $request->validate([
            'mode_paiement' => 'required|string|max:255',
            'reference_paiement' => 'nullable|string|max:255',
        ]);

        // =======================================
        // APPEL MÃ‰THODE MÃ‰TIER SPÃ‰CIALISÃ‰E
        // =======================================
        
        $facture->marquerPayee(
            $validated['mode_paiement'],
            $validated['reference_paiement'] ?? null
        );

        // =======================================
        // NOTIFICATION ENRICHIE PAIEMENT
        // =======================================
        
        $facture->sendCustomNotification('paid',
            "La facture #{$facture->numero_facture} de {$facture->client->prenom} {$facture->client->nom} a Ã©tÃ© marquÃ©e comme payÃ©e (Montant: " . number_format($facture->montant_ttc, 2) . "â‚¬, Mode: {$validated['mode_paiement']})"
        );

        return redirect()->back()
            ->with('success', 'ğŸ’° Facture ' . $facture->numero_facture . ' marquÃ©e comme payÃ©e !');

    } catch (ValidationException $e) {
        return back()
            ->withErrors($e->errors())
            ->with('error', 'âŒ Erreur de validation. Veuillez vÃ©rifier les informations saisies.');
    } catch (Exception $e) {
        return back()
            ->with('error', 'âŒ Une erreur est survenue lors de la mise Ã  jour du statut de paiement.');
    }
}
```

## ğŸ“„ MÃ©thodes PDF SpÃ©cialisÃ©es

### voirPdf() et telechargerPdf()

```php
/**
 * Consultation PDF avec contrÃ´les d'accÃ¨s
 */
public function voirPdf(Facture $facture)
{
    $cheminPdf = $this->facturePdfService->getCheminPdf($facture);
    
    if (!$cheminPdf || !file_exists($cheminPdf)) {
        return redirect()->back()
            ->with('error', 'âŒ PDF non trouvÃ©. Veuillez le gÃ©nÃ©rer depuis la page de dÃ©tail.');
    }

    return response()->file($cheminPdf, [
        'Content-Type' => 'application/pdf',
        'Content-Disposition' => 'inline; filename="' . basename($cheminPdf) . '"'
    ]);
}

/**
 * TÃ©lÃ©chargement PDF avec nommage fiscal
 */
public function telechargerPdf(Facture $facture)
{
    $cheminPdf = $this->facturePdfService->getCheminPdf($facture);
    
    if (!$cheminPdf || !file_exists($cheminPdf)) {
        return redirect()->back()
            ->with('error', 'âŒ PDF non trouvÃ©. Veuillez le gÃ©nÃ©rer depuis la page de dÃ©tail.');
    }

    // â­ NOMMAGE FISCAL : facture_{numero_facture}.pdf
    $nomTelecharge = "facture_{$facture->numero_facture}.pdf";

    return response()->download($cheminPdf, $nomTelecharge, [
        'Content-Type' => 'application/pdf'
    ]);
}
```

### syncSupabase() - Synchronisation Cloud

```php
/**
 * Synchronise le PDF vers Supabase Storage avec URL publique
 */
public function syncSupabase(Facture $facture)
{
    try {
        $cheminPdf = $this->facturePdfService->getCheminPdf($facture);
        
        if (!$cheminPdf || !file_exists($cheminPdf)) {
            return redirect()->route('factures.show', $facture->id)
                ->with('error', 'âŒ PDF non trouvÃ© localement. Veuillez d\'abord le gÃ©nÃ©rer.');
        }

        // â­ SYNCHRONISATION AVEC URL PUBLIQUE
        $urlPublique = $this->facturePdfService->synchroniserVersSupabase($facture);

        // â­ MISE Ã€ JOUR pdf_url EN BASE
        $facture->pdf_url = $urlPublique;
        $facture->save();

        Log::info('Synchronisation Supabase rÃ©ussie pour facture', [
            'facture_id' => $facture->id,
            'numero_facture' => $facture->numero_facture,
            'url_publique' => $urlPublique
        ]);

        return redirect()->route('factures.show', $facture->id)
            ->with('success', 'âœ… PDF synchronisÃ© avec succÃ¨s vers Supabase !');

    } catch (Exception $e) {
        Log::error('Erreur synchronisation Supabase pour facture', [
            'facture_id' => $facture->id,
            'error' => $e->getMessage()
        ]);

        return redirect()->route('factures.show', $facture->id)
            ->with('error', 'âŒ Erreur lors de la synchronisation : ' . $e->getMessage());
    }
}
```

## ğŸ—‘ï¸ Suppression avec ContrÃ´les

### destroy() - Suppression SÃ©curisÃ©e

```php
/**
 * Supprime une facture avec vÃ©rifications lÃ©gales
 */
public function destroy(Facture $facture)
{
    try {
        $numero_facture = $facture->numero_facture;

        // =======================================
        // SUPPRESSION PDF PRÃ‰ALABLE
        // =======================================
        
        try {
            $this->facturePdfService->supprimer($facture);
            Log::info('PDF supprimÃ© lors de la suppression de la facture', [
                'facture_id' => $facture->id,
                'numero_facture' => $numero_facture
            ]);
        } catch (Exception $e) {
            Log::error('Erreur suppression PDF lors suppression facture', [
                'facture_id' => $facture->id,
                'error' => $e->getMessage()
            ]);
        }

        // âš ï¸ VÃ‰RIFICATIONS LÃ‰GALES POSSIBLES :
        // - Facture non payÃ©e
        // - Pas de lien avec comptabilitÃ©
        // - Autorisations spÃ©ciales requises

        $facture->delete();

        return redirect()->route('factures.index')
            ->with('warning', 'âš ï¸ Facture ' . $numero_facture . ' supprimÃ©e avec succÃ¨s.');

    } catch (Exception $e) {
        return back()
            ->with('error', 'âŒ Impossible de supprimer la facture. Elle pourrait Ãªtre liÃ©e Ã  d\'autres donnÃ©es.');
    }
}
```

## ğŸ“§ MÃ©thodes Email SpÃ©cialisÃ©es

### envoyerEmailForm() et envoyerEmail()

```php
/**
 * Formulaire d'envoi avec templates fiscaux
 */
public function envoyerEmailForm(Facture $facture)
{
    $facture->load(['client.entreprise', 'administrateur']);
    
    // â­ TEMPLATES SPÃ‰CIALISÃ‰S FACTURES
    $templates = [
        'facture_client' => [
            'nom' => 'ğŸ“§ Email client - Facture',
            'description' => 'Template standard d\'envoi de facture au client',
            'destinataire' => 'client'
        ],
        'facture_admin' => [
            'nom' => 'ğŸ“§ Email admin - Notification',
            'description' => 'Notification aux administrateurs',
            'destinataire' => 'admin'
        ]
    ];

    return Inertia::render('factures/envoyer-email', [
        'facture' => $facture,
        'templates' => $templates,
        'emails' => [
            'client' => $facture->client->email,
            'admin' => $facture->administrateur?->email
        ]
    ]);
}

/**
 * Envoi email avec PDF obligatoire
 */
public function envoyerEmail(Request $request, Facture $facture)
{
    // Logique d'envoi avec EmailLogService
    // + Attachement PDF obligatoire
    // + TraÃ§abilitÃ© complÃ¨te
    // Voir Module 2.3 pour dÃ©tails complets
}
```

## ğŸ“Š MÃ©thodes Utilitaires

### getPdfStatusData() - Statut PDF AvancÃ©

```php
/**
 * RÃ©cupÃ¨re le statut dÃ©taillÃ© du PDF pour le frontend
 */
private function getPdfStatusData(Facture $facture): array
{
    try {
        $status = [
            'exists' => false,
            'up_to_date' => false,
            'local_size' => 0,
            'last_modified' => null,
        ];

        // â­ VÃ‰RIFICATION EXISTENCE LOCALE
        $cheminPdf = $this->facturePdfService->getCheminPdf($facture);
        if ($cheminPdf && file_exists($cheminPdf)) {
            $status['exists'] = true;
            $status['local_size'] = filesize($cheminPdf);
            $status['last_modified'] = date('Y-m-d H:i:s', filemtime($cheminPdf));

            // â­ VÃ‰RIFICATION COHÃ‰RENCE TEMPORELLE
            $dateModifPdf = filemtime($cheminPdf);
            $dateModifFacture = $facture->updated_at->timestamp;
            $status['up_to_date'] = $dateModifFacture <= $dateModifPdf;
        }

        return $status;

    } catch (Exception $e) {
        Log::error('Erreur lors de la rÃ©cupÃ©ration du statut PDF pour show', [
            'facture_id' => $facture->id,
            'error' => $e->getMessage()
        ]);

        return [
            'exists' => false,
            'up_to_date' => false,
            'local_size' => 0,
            'last_modified' => null,
        ];
    }
}
```

## ğŸ“‹ RÃ©sumÃ© du FactureController

### CaractÃ©ristiques Principales

1. **ğŸ”¢ 1270 lignes** de code avec logique mÃ©tier complexe
2. **âš–ï¸ 14 mÃ©thodes principales** avec contraintes fiscales
3. **ğŸ’° Gestion paiements** spÃ©cialisÃ©e avec rÃ©fÃ©rences
4. **ğŸ“„ PDF obligatoire** avec synchronisation Supabase
5. **ğŸ” Validations strictes** pour conformitÃ© lÃ©gale
6. **ğŸ“§ Templates spÃ©cialisÃ©s** pour communications fiscales

### DiffÃ©rences Majeures vs DevisController

- **Contraintes fiscales** : Validations plus strictes
- **Gestion paiements** : MÃ©thodes `changerStatut()` et `marquerPayee()`
- **PDF obligatoire** : Statut et synchronisation avancÃ©s
- **Ã‰dition limitÃ©e** : Contraintes document fiscal
- **NumÃ©rotation** : Auto-gÃ©nÃ©ration format FACT-YYYY-NNNN
- **Statuts spÃ©cialisÃ©s** : 6 statuts vs 4 pour les devis

Cette architecture garantit une gestion professionnelle et conforme des factures avec toutes les contraintes lÃ©gales et fiscales nÃ©cessaires. 